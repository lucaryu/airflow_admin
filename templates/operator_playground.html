{% extends 'base.html' %}

{% block title %}Operator Playground - Toy Airflow{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/codemirror/css/codemirror.min.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/codemirror/css/dracula.min.css') }}">
<style>
    .playground-wrapper {
        display: flex;
        height: calc(100vh - 80px);
        gap: 15px;
        padding: 75px 0 0 0;
        box-sizing: border-box;
    }

    .op-sidebar {
        width: 250px;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .op-sidebar-header {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--table-header-bg);
    }

    .op-sidebar-header h3 {
        margin: 0;
        font-size: 16px;
        color: var(--text-primary);
    }

    .btn-action {
        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .btn-action:hover {
        opacity: 0.9;
    }

    .btn-danger {
        background-color: var(--danger-color);
    }

    .btn-success {
        background-color: var(--success-color);
    }

    .btn-warning {
        background-color: #ff9800;
        color: #fff;
    }

    .op-list {
        flex: 1;
        overflow-y: auto;
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .op-item {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .op-item:hover,
    .op-item.active {
        background-color: var(--hover-bg);
        border-right: 3px solid var(--primary-color);
    }

    .op-item-title {
        font-weight: 500;
        color: var(--text-primary);
        word-break: break-all;
    }

    .op-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
        min-width: 0;
    }

    .op-header {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .op-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 15px;
    }

    .op-input {
        width: 300px;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        background-color: var(--bg-color);
        color: var(--text-primary);
    }

    .op-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .kernel-status {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        padding: 5px 10px;
        border-radius: 12px;
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #4CAF50;
        /* idle */
    }

    .status-dot.busy {
        background-color: #ffeb3b;
    }

    .status-dot.error {
        background-color: #f44336;
    }

    .notebook-container {
        flex: 1;
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* Cells */
    .cell {
        display: flex;
        gap: 10px;
    }

    .cell-gutter {
        width: 50px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        padding-top: 10px;
        font-family: monospace;
        color: var(--text-secondary);
    }

    .btn-run-cell {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        margin-top: 8px;
        font-size: 16px;
    }

    .btn-run-cell:hover {
        color: var(--primary-color);
    }

    .btn-del-cell {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        margin-top: 8px;
        font-size: 14px;
    }

    .btn-del-cell:hover {
        color: var(--danger-color);
    }

    .cell-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        overflow: hidden;
        background-color: #282a36;
        /* dracula bg */
    }

    .CodeMirror {
        height: auto;
        min-height: 50px;
        font-family: 'Consolas', 'Courier New', monospace;
        font-size: 14px;
    }

    .cell-output {
        padding: 10px;
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Consolas', monospace;
        font-size: 13px;
        white-space: pre-wrap;
        border-top: 1px solid var(--border-color);
        display: none;
    }

    .cell-output.has-content {
        display: block;
    }

    .out-error {
        color: #ff5555;
    }

    .out-stream {
        color: #d4d4d4;
    }

    .out-result {
        color: #50fa7b;
    }
</style>
{% endblock %}

{% block content %}
<div class="playground-wrapper">
    <!-- Left Sidebar: Saved Operators -->
    <div class="op-sidebar">
        <div class="op-sidebar-header">
            <h3>Operators</h3>
            <button class="btn-action" onclick="createNew()"><i class="fas fa-plus"></i> New</button>
        </div>
        <ul class="op-list" id="operatorList">
            <!-- Populated via JS -->
        </ul>
    </div>

    <!-- Main Workspace -->
    <div class="op-main">
        <div class="op-header">
            <div class="op-header-row">
                <input type="text" id="opName" class="op-input" placeholder="Operator Name (e.g., custom_etl)">
                <div class="op-actions">
                    <div class="kernel-status" id="kernelStatus">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">Python 3 (idle)</span>
                    </div>
                </div>
            </div>
            <div class="op-header-row">
                <input type="text" id="opDesc" class="op-input" placeholder="Description (Optional)"
                    style="width: 100%;">
            </div>
            <div class="op-header-row">
                <div class="op-actions">
                    <button class="btn-action btn-success" onclick="saveOperator()"><i class="fas fa-save"></i>
                        Save</button>
                    <button class="btn-action btn-danger" onclick="deleteOperator()" id="btnDelete"
                        style="display:none;"><i class="fas fa-trash"></i> Delete</button>
                </div>
                <div class="op-actions">
                    <button class="btn-action" onclick="addCell()"><i class="fas fa-plus"></i> Add Cell</button>
                    <button class="btn-action btn-warning" onclick="restartKernel()"><i class="fas fa-sync-alt"></i>
                        Restart Kernel</button>
                </div>
            </div>
        </div>

        <div class="notebook-container" id="notebook">
            <!-- Cells will be dynamic -->
        </div>
    </div>


</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='vendor/codemirror/js/codemirror.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/codemirror/js/mode/python/python.min.js') }}"
    onerror="this.remove()"></script>
<script>
    let currentOperatorId = null;
    let cells = []; // Array of objects { element, cm, outputBlock }
    let executionCounter = 1;

    document.addEventListener('DOMContentLoaded', () => {
        loadOperators();
        createNew(false); // Add one empty cell
    });

    function setKernelStatus(status) {
        const dot = document.getElementById('statusDot');
        const txt = document.getElementById('statusText');
        dot.className = 'status-dot';
        if (status === 'busy') {
            dot.classList.add('busy');
            txt.textContent = 'Python 3 (busy...)';
        } else if (status === 'error') {
            dot.classList.add('error');
            txt.textContent = 'Python 3 (error)';
        } else {
            txt.textContent = 'Python 3 (idle)';
        }
    }



    function createNew(clearList = true) {
        currentOperatorId = null;
        document.getElementById('opName').value = '';
        document.getElementById('opDesc').value = '';
        document.getElementById('btnDelete').style.display = 'none';

        if (clearList) {
            document.querySelectorAll('.op-item').forEach(el => el.classList.remove('active'));
        }

        // Clear notebook
        const nb = document.getElementById('notebook');
        nb.innerHTML = '';
        cells = [];

        // Default initial cell
        addCell('# Write your custom Airflow Operator prototype code here\nfrom airflow.hooks.base import BaseHook\n\n');
    }

    function addCell(initialCode = '') {
        const nb = document.getElementById('notebook');

        const cellDiv = document.createElement('div');
        cellDiv.className = 'cell';

        const cellIndex = cells.length;

        cellDiv.innerHTML = `
            <div class="cell-gutter">
                <span class="prompt-text">In [ ]:</span>
                <button class="btn-run-cell" title="Run Cell"><i class="fas fa-play"></i></button>
                <button class="btn-del-cell" title="Delete Cell"><i class="fas fa-trash"></i></button>
            </div>
            <div class="cell-content">
                <div class="cell-input"></div>
                <div class="cell-output"></div>
            </div>
        `;

        nb.appendChild(cellDiv);

        const inputDiv = cellDiv.querySelector('.cell-input');
        const outputDiv = cellDiv.querySelector('.cell-output');
        const runBtn = cellDiv.querySelector('.btn-run-cell');
        const delBtn = cellDiv.querySelector('.btn-del-cell');
        const promptTxt = cellDiv.querySelector('.prompt-text');

        // Init CodeMirror
        const cm = CodeMirror(inputDiv, {
            value: initialCode,
            mode: 'python',
            theme: 'dracula',
            lineNumbers: false,
            viewportMargin: Infinity // Auto-resize
        });

        const cellObj = {
            dom: cellDiv,
            cm: cm,
            output: outputDiv,
            prompt: promptTxt
        };

        cells.push(cellObj);

        // Events
        runBtn.onclick = () => runCell(cellObj);
        delBtn.onclick = () => {
            nb.removeChild(cellDiv);
            cells = cells.filter(c => c !== cellObj);
        };

        // focus
        setTimeout(() => cm.refresh(), 10);
    }

    async function runCell(cellObj) {
        const code = cellObj.cm.getValue();
        if (!code.trim()) return;

        cellObj.output.innerHTML = '';
        cellObj.output.classList.remove('has-content');
        cellObj.prompt.textContent = `In [*]:`;
        setKernelStatus('busy');

        try {
            const res = await fetch('/api/run_code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            });

            const data = await res.json();

            let htmlOut = '';

            if (data.outputs && data.outputs.length > 0) {
                data.outputs.forEach(out => {
                    if (out.type === 'stream') {
                        htmlOut += `<span class="out-stream">${escapeHtml(out.text)}</span>`;
                    } else if (out.type === 'error') {
                        htmlOut += `<span class="out-error">${escapeHtml(out.traceback.join('\\n'))}</span>\\n`;
                    } else if (out.type === 'execute_result' || out.type === 'display_data') {
                        htmlOut += `<span class="out-result">${escapeHtml(out.data)}</span>\\n`;
                    }
                });
            } else if (data.stdout || data.stderr) {
                // Fallback
                if (data.stdout) htmlOut += `<span class="out-stream">${escapeHtml(data.stdout)}</span>`;
                if (data.stderr) htmlOut += `<span class="out-error">${escapeHtml(data.stderr)}</span>`;
            }

            if (htmlOut) {
                cellObj.output.innerHTML = htmlOut;
                cellObj.output.classList.add('has-content');
            }

            cellObj.prompt.textContent = `In [${executionCounter++}]:`;
            setKernelStatus('idle');

        } catch (e) {
            cellObj.output.innerHTML = `<span class="out-error">${escapeHtml(e.message)}</span>`;
            cellObj.output.classList.add('has-content');
            cellObj.prompt.textContent = `In [!]:`;
            setKernelStatus('error');
        }
    }

    async function restartKernel() {
        setKernelStatus('busy');
        try {
            const res = await fetch('/api/restart_kernel', { method: 'POST' });
            if (res.ok) {
                setKernelStatus('idle');
                executionCounter = 1;
                cells.forEach(c => {
                    c.prompt.textContent = 'In [ ]:';
                    c.output.innerHTML = '';
                    c.output.classList.remove('has-content');
                });
            }
        } catch (e) {
            alert('Failed to restart kernel');
            setKernelStatus('error');
        }
    }

    // --- Serialization logic for saving operators ---
    // A primitive notebook format, we bundle all cell codes with a separator
    const CELL_SEPARATOR = '\\n# --- CELL ---\\n';

    function getCombinedCode() {
        return cells.map(c => c.cm.getValue()).join(CELL_SEPARATOR);
    }

    function populateFromCombinedCode(code) {
        document.getElementById('notebook').innerHTML = '';
        cells = [];

        const parts = code.split(CELL_SEPARATOR);
        parts.forEach(p => {
            if (p) addCell(p);
        });
        if (cells.length === 0) addCell();
    }

    async function loadOperators() {
        try {
            const res = await fetch('/api/operators');
            const data = await res.json();
            const listEl = document.getElementById('operatorList');
            listEl.innerHTML = '';

            data.forEach(op => {
                const li = document.createElement('li');
                li.className = 'op-item';
                if (op.id === currentOperatorId) li.classList.add('active');
                const dateObj = new Date(op.updated_at);
                li.innerHTML = `
                    <div class="op-item-title">${op.name}</div>
                    <div style="font-size:11px; color:var(--text-secondary)">${dateObj.toLocaleString()}</div>
                `;
                li.onclick = () => loadOperator(op.id);
                listEl.appendChild(li);
            });
        } catch (e) { console.error('Failed to load operators', e); }
    }

    async function loadOperator(id) {
        try {
            const res = await fetch(`/api/operators/${id}`);
            const data = await res.json();
            currentOperatorId = data.id;
            document.getElementById('opName').value = data.name;
            document.getElementById('opDesc').value = data.description || '';

            populateFromCombinedCode(data.code || '');

            document.getElementById('btnDelete').style.display = 'flex';
            document.querySelectorAll('.op-item').forEach(el => el.classList.remove('active'));
            loadOperators();
        } catch (e) { console.error('Failed to load operator', e); }
    }

    async function saveOperator() {
        const name = document.getElementById('opName').value.trim();
        const desc = document.getElementById('opDesc').value.trim();
        const code = getCombinedCode();

        if (!name) { alert('Please enter an operator name.'); return; }

        const payload = { name, description: desc, code };
        const method = currentOperatorId ? 'PUT' : 'POST';
        const url = currentOperatorId ? `/api/operators/${currentOperatorId}` : '/api/operators';

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (res.ok) {
                if (!currentOperatorId && data.id) {
                    currentOperatorId = data.id;
                    document.getElementById('btnDelete').style.display = 'flex';
                }
                loadOperators();
                alert('Saved successfully!');
            } else { alert('Error: ' + data.message); }
        } catch (e) { alert('Failed to save.'); }
    }

    async function deleteOperator() {
        if (!currentOperatorId) return;
        if (!confirm('Delete this operator?')) return;
        try {
            const res = await fetch(`/api/operators/${currentOperatorId}`, { method: 'DELETE' });
            if (res.ok) { createNew(); loadOperators(); }
        } catch (e) { console.error(e); }
    }

    function escapeHtml(unsafe) {
        return (unsafe || "").toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>
{% endblock %}