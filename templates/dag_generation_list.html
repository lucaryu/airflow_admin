{% extends 'base.html' %}

{% block title %}Toy Airflow - DAG List{% endblock %}

{% block styles %}
<!-- Prism.js for Syntax Highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
<style>
    /* Modal Maximized Styles */
    .modal-content.maximized {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        max-width: none !important;
        height: 100vh !important;
        margin: 0 !important;
        border-radius: 0 !important;
        z-index: 9999 !important;
        display: flex !important;
        flex-direction: column !important;
    }

    .maximized .modal-body-container {
        max-height: none !important;
        height: calc(100vh - 70px) !important;
        flex: 1 !important;
    }

    .modal-header-actions {
        display: flex;
        gap: 20px !important;
        align-items: center;
        margin-right: 5px;
    }

    .action-icon {
        cursor: pointer;
        padding: 6px;
        color: #aaa;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 20px !important;
    }

    .action-icon:hover {
        color: #fff;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }

    .code-container {
        position: relative;
    }

    .copy-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff;
        padding: 5px 12px;
        border-radius: 4px;
        font-size: 13px;
        cursor: pointer;
        z-index: 100;
        transition: all 0.2s;
    }

    .copy-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
    }

    /* Prism Fixes */
    pre[class*="language-"] {
        margin: 0 !important;
        background: transparent !important;
    }

    code[class*="language-"] {
        text-shadow: none !important;
    }

    /* Sortable Table Headers */
    .data-table thead th.sortable {
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
        position: relative;
        padding-right: 22px;
    }

    .data-table thead th.sortable:hover {
        background-color: rgba(255, 255, 255, 0.07);
    }

    .sort-icon {
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 11px;
        opacity: 0.35;
        transition: opacity 0.2s, color 0.2s;
    }

    .data-table thead th.sort-asc .sort-icon,
    .data-table thead th.sort-desc .sort-icon {
        opacity: 1;
        color: #4cc9f0;
    }

    .sort-badge {
        display: inline-block;
        font-size: 9px;
        background: #4cc9f0;
        color: #000;
        border-radius: 3px;
        padding: 1px 4px;
        margin-left: 4px;
        font-weight: 700;
        vertical-align: middle;
        line-height: 1.4;
    }

    /* Advanced Sort Modal */
    #advSortModal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.55);
        align-items: center;
        justify-content: center;
    }

    #advSortModal.open {
        display: flex;
    }

    .adv-sort-box {
        background: #1e1e2e;
        border: 1px solid #333;
        border-radius: 10px;
        padding: 28px 32px;
        min-width: 520px;
        max-width: 620px;
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6);
    }

    .adv-sort-box h3 {
        margin: 0 0 18px;
        font-size: 1.1rem;
        color: #e0e0e0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .adv-sort-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
    }

    .adv-sort-row select {
        flex: 1;
        background: #2a2a3e;
        border: 1px solid #444;
        color: #e0e0e0;
        border-radius: 5px;
        padding: 7px 10px;
        font-size: 13px;
    }

    .adv-sort-row select:focus {
        outline: none;
        border-color: #4cc9f0;
    }

    .adv-sort-drag-handle {
        color: #666;
        cursor: grab;
        padding: 0 4px;
        font-size: 16px;
    }

    .adv-sort-remove {
        background: none;
        border: none;
        color: #e55;
        cursor: pointer;
        font-size: 16px;
        padding: 4px 6px;
        border-radius: 4px;
        transition: background 0.15s;
    }

    .adv-sort-remove:hover {
        background: rgba(255, 80, 80, 0.12);
    }

    .adv-sort-add {
        background: none;
        border: 1px dashed #4cc9f0;
        color: #4cc9f0;
        border-radius: 5px;
        padding: 6px 14px;
        cursor: pointer;
        font-size: 13px;
        margin-top: 4px;
        transition: background 0.15s;
    }

    .adv-sort-add:hover {
        background: rgba(76, 201, 240, 0.08);
    }

    .adv-sort-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid #333;
    }
</style>
{% endblock %}

{% block content %}
<header class="page-header">
    <h1 class="page-title">Generated DAGs</h1>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-danger" id="bulkDeleteBtn" style="display: none;" onclick="bulkDeleteDags()">
            <i class="fas fa-trash-alt"></i>
            <span class="btn-icon-right">Delete Selected</span>
        </button>
        <button class="btn" style="background:#2a2a3e; border:1px solid #444; color:#aaa;" onclick="openAdvSort()"
            title="고급 정렬">
            <i class="fas fa-sort-amount-down"></i>
            <span class="btn-icon-right">Advanced Sort</span>
        </button>
        <button class="btn btn-primary">
            <i class="fas fa-sync"></i>
            <span class="btn-icon-right">Refresh Status</span>
        </button>
    </div>
</header>

<div class="content-body">
    <!-- Search/Filter Area -->
    <div class="card"
        style="display: flex; gap: var(--spacing-md); align-items: center; padding: var(--spacing-sm) var(--spacing-md);">
        <div style="flex: 1;">
            <input type="text" class="form-input" placeholder="Search DAGs...">
        </div>
        <div>
            <select class="form-select">
                <option>All Statuses</option>
                <option>Deployed</option>
                <option>Draft</option>
            </select>
        </div>
    </div>

    <div class="card" style="padding: 0; overflow: hidden;">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 40px; text-align: center;"><input type="checkbox" id="selectAllCheckbox"
                            onchange="toggleSelectAll()"></th>
                    <th class="sortable" data-col="0" onclick="sortByColumn(this)">DAG ID<i
                            class="fas fa-sort sort-icon"></i></th>
                    <th class="sortable" data-col="1" onclick="sortByColumn(this)">Description<i
                            class="fas fa-sort sort-icon"></i></th>
                    <th class="sortable" data-col="2" onclick="sortByColumn(this)">Template<i
                            class="fas fa-sort sort-icon"></i></th>
                    <th class="sortable" data-col="3" onclick="sortByColumn(this)">Created At<i
                            class="fas fa-sort sort-icon"></i></th>
                    <th class="sortable" data-col="4" onclick="sortByColumn(this)">Status<i
                            class="fas fa-sort sort-icon"></i></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for dag in dags %}
                <tr>
                    <td style="text-align: center;"><input type="checkbox" class="dag-checkbox" value="{{ dag.id }}"
                            onchange="updateBulkDeleteButton()"></td>
                    <td style="font-family: monospace;">{{ dag.filename }}</td>
                    <td>{{ dag.mapping.source_table }} -> {{ dag.mapping.target_table }}</td>
                    <td>{{ dag.template.name if dag.template else 'Deleted Template' }}</td>
                    <td>{{ dag.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td><span class="status-badge status-{{ 'active' if dag.status == 'Deployed' else 'inactive' }}">{{
                            dag.status }}</span></td>
                    <td>
                        <button class="btn btn-sm btn-info" style="padding: 4px 8px;" title="View Code"
                            onclick="viewDagCode({{ dag.id }})"><i class="fas fa-code"></i></button>
                        <button class="btn btn-sm btn-success" style="padding: 4px 8px;" title="Download"
                            onclick="downloadDag({{ dag.id }})"><i class="fas fa-download"></i></button>
                        <button class="btn btn-sm btn-danger" style="padding: 4px 8px;" title="Delete"
                            onclick="deleteDag({{ dag.id }})"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" style="text-align: center; color: var(--text-secondary);">No generated DAGs found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- View Code Modal -->
<div id="codeModal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.4);">
    <div id="codeModalContentContainer" class="modal-content"
        style="background-color: #1e1e1e; margin: 5% auto; padding: 20px; border: 1px solid #444; width: 80%; max-width: 900px; border-radius: 8px; color: #e0e0e0; display: flex; flex-direction: column; transition: all 0.3s ease;">
        <div class="modal-header"
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 id="codeModalTitle" style="margin: 0; font-size: 1.25rem;">DAG Code</h2>
            <div class="modal-header-actions">
                <span class="action-icon" title="Copy Code" onclick="copyCode()"><i class="far fa-copy"></i></span>
                <span id="maximizeBtn" class="action-icon" title="Maximize" onclick="toggleMaximize()"><i
                        class="far fa-window-maximize"></i></span>
                <span class="action-icon" style="font-size: 24px; line-height: 1;"
                    onclick="closeCodeModal()">&times;</span>
            </div>
        </div>
        <div class="code-container modal-body-container"
            style="background-color: #2d2d2d; border-radius: 4px; overflow: auto; flex: 1; max-height: 600px; padding-top: 40px;"
            id="modalBodyContainer">
            <button class="copy-btn" onclick="copyCode()" style="top: 15px; right: 20px;"><i class="far fa-copy"></i>
                Copy</button>
            <pre
                style="margin: 0;"><code id="codeModalContent" class="language-python" style="font-family: 'Consolas', 'Monaco', monospace; background: transparent !important;">Loading...</code></pre>
        </div>
    </div>
</div>

<!-- Advanced Sort Modal -->
<div id="advSortModal">
    <div class="adv-sort-box">
        <h3><i class="fas fa-sort-amount-down" style="color:#4cc9f0"></i> 고급 정렬</h3>
        <div id="advSortRows"></div>
        <button class="adv-sort-add" onclick="addAdvSortRow()"><i class="fas fa-plus"></i> 정렬 기준 추가</button>
        <div class="adv-sort-footer">
            <button class="btn" style="background:#333; color:#aaa; border:1px solid #555;"
                onclick="closeAdvSort()">취소</button>
            <button class="btn btn-primary" onclick="applyAdvSort()"><i class="fas fa-check"></i> 적용</button>
        </div>
    </div>
</div>

<script>
    /* ========== SORT LOGIC ========== */
    const COL_NAMES = ['DAG ID', 'Description', 'Template', 'Created At', 'Status'];
    // col index in <td>: checkbox=0, dagid=1, desc=2, template=3, createdat=4, status=5, actions=6
    const TD_INDEX = [1, 2, 3, 4, 5]; // maps data-col 0..4 to td index

    let singleSortCol = null;   // { colIdx, dir: 'asc'|'desc' }
    let advSortCriteria = [];   // [{ colIdx, dir }, ...]
    let isAdvMode = false;

    /* --- Single column sort (header click) --- */
    function sortByColumn(th) {
        const colIdx = parseInt(th.dataset.col);

        // Toggle direction
        if (singleSortCol && singleSortCol.colIdx === colIdx) {
            singleSortCol.dir = singleSortCol.dir === 'asc' ? 'desc' : 'asc';
        } else {
            singleSortCol = { colIdx, dir: 'asc' };
        }

        isAdvMode = false;
        advSortCriteria = [];

        applySort([singleSortCol]);
        updateSortHeaders([singleSortCol]);
    }

    /* --- Core sort function --- */
    function applySort(criteria) {
        const tbody = document.querySelector('.data-table tbody');
        const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => r.cells.length > 2);

        rows.sort((a, b) => {
            for (const { colIdx, dir } of criteria) {
                const tdIdx = TD_INDEX[colIdx];
                const aText = (a.cells[tdIdx]?.innerText || '').trim();
                const bText = (b.cells[tdIdx]?.innerText || '').trim();

                // Date-aware compare
                const aDate = Date.parse(aText);
                const bDate = Date.parse(bText);
                let cmp;
                if (!isNaN(aDate) && !isNaN(bDate)) {
                    cmp = aDate - bDate;
                } else {
                    cmp = aText.localeCompare(bText, undefined, { numeric: true, sensitivity: 'base' });
                }
                if (cmp !== 0) return dir === 'asc' ? cmp : -cmp;
            }
            return 0;
        });

        rows.forEach(r => tbody.appendChild(r));
    }

    /* --- Update header visual state --- */
    function updateSortHeaders(criteria) {
        document.querySelectorAll('.data-table thead th.sortable').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            const icon = th.querySelector('.sort-icon');
            const badge = th.querySelector('.sort-badge');
            if (badge) badge.remove();
            if (icon) icon.className = 'fas fa-sort sort-icon';
        });

        criteria.forEach((c, i) => {
            const th = document.querySelector(`.data-table thead th[data-col="${c.colIdx}"]`);
            if (!th) return;
            th.classList.add(c.dir === 'asc' ? 'sort-asc' : 'sort-desc');
            const icon = th.querySelector('.sort-icon');
            if (icon) icon.className = `fas fa-sort-${c.dir === 'asc' ? 'up' : 'down'} sort-icon`;

            if (criteria.length > 1) {
                const badge = document.createElement('span');
                badge.className = 'sort-badge';
                badge.textContent = i + 1;
                th.insertBefore(badge, icon);
            }
        });
    }

    /* ========== ADVANCED SORT MODAL ========== */
    function openAdvSort() {
        // Pre-fill with current state
        if (isAdvMode && advSortCriteria.length > 0) {
            renderAdvRows(advSortCriteria);
        } else if (singleSortCol) {
            renderAdvRows([singleSortCol]);
        } else {
            renderAdvRows([{ colIdx: 0, dir: 'asc' }]);
        }
        document.getElementById('advSortModal').classList.add('open');
    }

    function closeAdvSort() {
        document.getElementById('advSortModal').classList.remove('open');
    }

    function renderAdvRows(criteria) {
        const container = document.getElementById('advSortRows');
        container.innerHTML = '';
        criteria.forEach((c, i) => addAdvSortRow(c.colIdx, c.dir));
    }

    function addAdvSortRow(colIdx = 0, dir = 'asc') {
        const container = document.getElementById('advSortRows');
        const row = document.createElement('div');
        row.className = 'adv-sort-row';
        row.innerHTML = `
            <span class="adv-sort-drag-handle"><i class="fas fa-grip-vertical"></i></span>
            <select class="adv-sort-col">
                ${COL_NAMES.map((n, i) => `<option value="${i}" ${i == colIdx ? 'selected' : ''}>${n}</option>`).join('')}
            </select>
            <select class="adv-sort-dir">
                <option value="asc" ${dir === 'asc' ? 'selected' : ''}>오름차순 ↑</option>
                <option value="desc" ${dir === 'desc' ? 'selected' : ''}>내림차순 ↓</option>
            </select>
            <button class="adv-sort-remove" onclick="this.closest('.adv-sort-row').remove()" title="삭제"><i class="fas fa-times"></i></button>
        `;
        container.appendChild(row);
    }

    function applyAdvSort() {
        const rows = document.querySelectorAll('#advSortRows .adv-sort-row');
        if (rows.length === 0) { closeAdvSort(); return; }

        advSortCriteria = Array.from(rows).map(row => ({
            colIdx: parseInt(row.querySelector('.adv-sort-col').value),
            dir: row.querySelector('.adv-sort-dir').value
        }));

        isAdvMode = true;
        singleSortCol = null;

        applySort(advSortCriteria);
        updateSortHeaders(advSortCriteria);
        closeAdvSort();
    }

    // Close modal on outside click
    document.getElementById('advSortModal').addEventListener('click', function (e) {
        if (e.target === this) closeAdvSort();
    });

    /* ========== ORIGINAL FUNCTIONS ========== */
    function viewDagCode(id) {
        const modal = document.getElementById('codeModal');
        const contentContainer = document.getElementById('codeModalContentContainer');
        const codeElement = document.getElementById('codeModalContent');
        const titleElement = document.getElementById('codeModalTitle');

        modal.style.display = 'block';
        // Reset state
        contentContainer.classList.remove('maximized');
        document.getElementById('maximizeBtn').innerHTML = '<i class="far fa-window-maximize"></i>';

        codeElement.textContent = 'Loading...';
        titleElement.textContent = 'Loading...';

        fetch(`/api/dags/${id}/code`)
            .then(async response => {
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || 'Error fetching code'); });
                    }
                    return response.json();
                } else {
                    const text = await response.text();
                    throw new Error('Server returned invalid response');
                }
            })
            .then(data => {
                titleElement.textContent = data.filename;
                codeElement.textContent = data.code;

                // Ensure Prism highlights correctly after content update
                requestAnimationFrame(() => {
                    Prism.highlightElement(codeElement);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                titleElement.textContent = 'Error';
                codeElement.textContent = error.message;
            });
    }

    function closeCodeModal() {
        document.getElementById('codeModal').style.display = 'none';
    }

    function toggleMaximize() {
        const contentContainer = document.getElementById('codeModalContentContainer');
        const btn = document.getElementById('maximizeBtn');
        const isMaximized = contentContainer.classList.toggle('maximized');

        if (isMaximized) {
            btn.innerHTML = '<i class="far fa-window-restore"></i>';
            btn.title = "Restore";
        } else {
            btn.innerHTML = '<i class="far fa-window-maximize"></i>';
            btn.title = "Maximize";
        }
    }

    function copyCode() {
        const code = document.getElementById('codeModalContent').textContent;
        navigator.clipboard.writeText(code).then(() => {
            const copyBtns = document.querySelectorAll('.copy-btn, .modal-header-actions .action-icon[title="Copy Code"]');

            // Visual feedback
            const originalText = [];
            copyBtns.forEach((btn, idx) => {
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-check';
                    setTimeout(() => {
                        icon.className = btn.classList.contains('copy-btn') ? 'far fa-copy' : 'far fa-copy';
                    }, 2000);
                }
                if (btn.classList.contains('copy-btn')) {
                    const span = btn.querySelector('span') || btn;
                    const oldText = btn.innerText;
                    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    setTimeout(() => {
                        btn.innerHTML = '<i class="far fa-copy"></i> Copy';
                    }, 2000);
                }
            });
        }).catch(err => {
            console.error('Failed to copy code:', err);
            alert('Failed to copy code to clipboard');
        });
    }

    // Close modal when clicking outside of it
    window.onclick = function (event) {
        var modal = document.getElementById('codeModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    function downloadDag(id) {
        // For download, we can't easily capture the error without AJAX, 
        // but typically browser handles 404 by showing the error page.
        // We could fetch HEAD first to check existence if needed, but keeping it simple for now.
        window.location.href = `/api/dags/${id}/download`;
    }

    function toggleSelectAll() {
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const checkboxes = document.querySelectorAll('.dag-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
        updateBulkDeleteButton();
    }

    function updateBulkDeleteButton() {
        const checkboxes = document.querySelectorAll('.dag-checkbox:checked');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        if (checkboxes.length > 0) {
            bulkDeleteBtn.style.display = 'inline-flex';
            bulkDeleteBtn.querySelector('span').textContent = `Delete Selected (${checkboxes.length})`;
        } else {
            bulkDeleteBtn.style.display = 'none';
        }

        // Update select all checkbox state if needed
        const allCheckboxes = document.querySelectorAll('.dag-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (checkboxes.length === allCheckboxes.length && allCheckboxes.length > 0) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else if (checkboxes.length > 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        }
    }

    function bulkDeleteDags() {
        const checkboxes = document.querySelectorAll('.dag-checkbox:checked');
        if (checkboxes.length === 0) return;

        if (confirm(`Are you sure you want to delete ${checkboxes.length} selected DAGs? This action cannot be undone.`)) {
            const dagIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            fetch('/api/dags/bulk_delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ dag_ids: dagIds })
            })
                .then(response => {
                    if (!response.ok && response.status !== 207) {
                        return response.json().then(err => { throw new Error(err.message || 'Error deleting DAGs'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success' || data.status === 'partial_success') {
                        if (data.status === 'partial_success') {
                            alert(data.message);
                        }
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message || 'An error occurred while deleting DAGs.');
                });
        }
    }

    function deleteDag(id) {
        if (confirm('Are you sure you want to delete this DAG? This action cannot be undone.')) {
            fetch(`/api/dags/${id}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || 'Error deleting DAG'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert(error.message || 'An error occurred while deleting the DAG.');
                });
        }
    }
</script>
{% endblock %}

{% block scripts %}
<!-- Prism.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
{% endblock %}