{% extends 'base.html' %}

{% block title %}Toy Airflow - Mapping List{% endblock %}

{% block styles %}
<style>
    /* Modal Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(2px);
    }

    .modal-container {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        max-width: 1000px;
        height: 80%;
        max-height: 800px;
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        flex-direction: column;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .modal-container.maximized {
        width: 100%;
        height: 100%;
        max-width: none;
        max-height: none;
        top: 0;
        left: 0;
        transform: none;
        border-radius: 0;
    }

    .modal-header {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-dark);
    }

    .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-md);
    }

    .modal-footer {
        padding: var(--spacing-md);
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        background: var(--bg-dark);
    }

    .column-grid {
        display: grid;
        grid-template-columns: 40px 1.5fr 1.5fr 1fr 40px 40px 40px 40px 2fr 1.5fr 1fr 40px;
        gap: 1px;
        background: var(--border-color);
        border: 1px solid var(--border-color);
    }

    .column-header {
        background: #2a2a2a;
        padding: 8px;
        font-weight: 600;
        font-size: 13px;
    }

    .column-cell {
        background: var(--card-bg);
        padding: 8px;
        font-size: 13px;
        display: flex;
        align-items: center;
    }

    .column-cell input {
        width: 100%;
        background: transparent;
        border: none;
        color: var(--text-primary);
    }

    .column-cell input:focus {
        outline: none;
        border-bottom: 1px solid var(--accent-color);
    }

    /* Sortable Table Headers */
    .data-table thead th.sortable {
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
        position: relative;
        padding-right: 22px;
    }

    .data-table thead th.sortable:hover {
        background-color: rgba(255, 255, 255, 0.07);
    }

    .sort-icon {
        position: absolute;
        right: 6px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 11px;
        opacity: 0.35;
        transition: opacity 0.2s, color 0.2s;
    }

    .data-table thead th.sort-asc .sort-icon,
    .data-table thead th.sort-desc .sort-icon {
        opacity: 1;
        color: #4cc9f0;
    }

    .sort-badge {
        display: inline-block;
        font-size: 9px;
        background: #4cc9f0;
        color: #000;
        border-radius: 3px;
        padding: 1px 4px;
        margin-left: 4px;
        font-weight: 700;
        vertical-align: middle;
        line-height: 1.4;
    }

    /* Advanced Sort Modal */
    #advSortModal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.55);
        align-items: center;
        justify-content: center;
    }

    #advSortModal.open {
        display: flex;
    }

    .adv-sort-box {
        background: #1e1e2e;
        border: 1px solid #333;
        border-radius: 10px;
        padding: 28px 32px;
        min-width: 520px;
        max-width: 620px;
        box-shadow: 0 8px 40px rgba(0, 0, 0, 0.6);
    }

    .adv-sort-box h3 {
        margin: 0 0 18px;
        font-size: 1.1rem;
        color: #e0e0e0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .adv-sort-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
    }

    .adv-sort-row select {
        flex: 1;
        background: #2a2a3e;
        border: 1px solid #444;
        color: #e0e0e0;
        border-radius: 5px;
        padding: 7px 10px;
        font-size: 13px;
    }

    .adv-sort-row select:focus {
        outline: none;
        border-color: #4cc9f0;
    }

    .adv-sort-drag-handle {
        color: #666;
        cursor: grab;
        padding: 0 4px;
        font-size: 16px;
    }

    .adv-sort-remove {
        background: none;
        border: none;
        color: #e55;
        cursor: pointer;
        font-size: 16px;
        padding: 4px 6px;
        border-radius: 4px;
        transition: background 0.15s;
    }

    .adv-sort-remove:hover {
        background: rgba(255, 80, 80, 0.12);
    }

    .adv-sort-add {
        background: none;
        border: 1px dashed #4cc9f0;
        color: #4cc9f0;
        border-radius: 5px;
        padding: 6px 14px;
        cursor: pointer;
        font-size: 13px;
        margin-top: 4px;
        transition: background 0.15s;
    }

    .adv-sort-add:hover {
        background: rgba(76, 201, 240, 0.08);
    }

    .adv-sort-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid #333;
    }

    /* ===== DAG ÏÉùÏÑ± Î™®Îã¨ Í∞úÏÑ† Ïä§ÌÉÄÏùº ===== */
    .dag-modal-section {
        margin-bottom: 20px;
        padding-bottom: 18px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.07);
    }

    .dag-modal-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .dag-section-title {
        font-size: 12px;
        font-weight: 600;
        color: #aaa;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* ÏÑ†ÌÉù Îß§Ìïë Î±ÉÏßÄ */
    .mapping-tags-wrap {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        max-height: 100px;
        overflow-y: auto;
        padding: 4px 0;
    }

    .mapping-tag {
        background: rgba(76, 201, 240, 0.12);
        border: 1px solid rgba(76, 201, 240, 0.35);
        color: #4cc9f0;
        border-radius: 4px;
        padding: 3px 9px;
        font-size: 12px;
        font-family: monospace;
        white-space: nowrap;
    }

    /* Ïä§ÏºÄÏ§Ñ ÌîÑÎ¶¨ÏÖã Î≤ÑÌäº */
    .schedule-preset-group {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 10px;
    }

    .schedule-preset-btn {
        background: #2a2a3e;
        border: 1px solid #444;
        color: #ccc;
        border-radius: 5px;
        padding: 5px 12px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.15s;
    }

    .schedule-preset-btn:hover {
        border-color: #4cc9f0;
        color: #4cc9f0;
    }

    .schedule-preset-btn.active {
        background: rgba(76, 201, 240, 0.15);
        border-color: #4cc9f0;
        color: #4cc9f0;
        font-weight: 600;
    }

    /* Ïä§ÏºÄÏ§Ñ ÏÉÅÏÑ∏ ÏòµÏÖò */
    .schedule-detail-box {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid #333;
        border-radius: 6px;
        padding: 12px 14px;
        margin-top: 4px;
    }

    .schedule-detail-row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 8px;
    }

    .schedule-detail-row:last-child {
        margin-bottom: 0;
    }

    .schedule-detail-label {
        font-size: 12px;
        color: #aaa;
        min-width: 40px;
    }

    .schedule-num-select {
        background: #2a2a3e;
        border: 1px solid #444;
        color: #e0e0e0;
        border-radius: 4px;
        padding: 3px 8px;
        font-size: 13px;
        cursor: pointer;
    }

    .schedule-num-select:focus {
        outline: none;
        border-color: #4cc9f0;
    }

    .cron-result-box {
        margin-top: 10px;
        background: #1a1a2e;
        border: 1px solid #2a2a4a;
        border-radius: 5px;
        padding: 7px 12px;
        font-family: monospace;
        font-size: 13px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
    }

    .cron-expr-display {
        color: #4cc9f0;
        font-weight: bold;
        letter-spacing: 0.05em;
    }

    .cron-desc-display {
        color: #aaa;
        font-size: 12px;
    }

    /* Catchup ÌÜ†Í∏Ä */
    .catchup-toggle-group {
        display: flex;
        gap: 0;
        border: 1px solid #444;
        border-radius: 5px;
        overflow: hidden;
        width: fit-content;
    }

    .catchup-toggle-btn {
        background: #2a2a3e;
        border: none;
        color: #888;
        padding: 5px 18px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.15s;
        border-right: 1px solid #444;
    }

    .catchup-toggle-btn:last-child {
        border-right: none;
    }

    .catchup-toggle-btn.active-on {
        background: rgba(46, 213, 115, 0.2);
        color: #2ed573;
        font-weight: 600;
    }

    .catchup-toggle-btn.active-off {
        background: rgba(255, 99, 99, 0.15);
        color: #ff6363;
        font-weight: 600;
    }

    /* ÏßÅÏ†ë ÏûÖÎ†• ÌÅ¨Î°† */
    .custom-cron-input {
        background: #2a2a3e;
        border: 1px solid #444;
        color: #e0e0e0;
        border-radius: 5px;
        padding: 6px 10px;
        font-family: monospace;
        font-size: 13px;
        width: 100%;
        transition: border-color 0.15s;
    }

    .custom-cron-input:focus {
        outline: none;
        border-color: #4cc9f0;
    }
</style>
{% endblock %}

{% block content %}
<header class="page-header">
    <h1 class="page-title">Mapping Definitions</h1>
    <div style="display: flex; gap: 8px;">
        <button class="btn btn-secondary" id="bulkDownloadBtn" style="display: none;" onclick="downloadSelected(this)">
            <i class="fas fa-file-excel" style="color: #1D6F42;"></i>
            <span class="btn-icon-right">Bulk Download</span>
        </button>
        <button class="btn btn-secondary" id="bulkDeleteBtn"
            style="display: none; color: var(--error-color); border-color: var(--error-color);"
            onclick="bulkDeleteMappings(this)">
            <i class="fas fa-trash"></i>
            <span class="btn-icon-right">Bulk Delete</span>
        </button>
        <button class="btn btn-primary" id="generateDagBtn"
            style="display: none; background-color: #e67e22; border-color: #e67e22;" onclick="openGenerateModal()">
            <i class="fas fa-magic"></i>
            <span class="btn-icon-right">Generate DAG</span>
        </button>
        <button class="btn" style="background:#2a2a3e; border:1px solid #444; color:#aaa;" onclick="openAdvSort()"
            title="Í≥†Í∏â Ï†ïÎ†¨">
            <i class="fas fa-sort-amount-down"></i>
            <span class="btn-icon-right">Advanced Sort</span>
        </button>
        <a href="{{ url_for('mappings.new_mapping') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            <span class="btn-icon-right">New Mapping</span>
        </a>
    </div>
</header>

<div class="content-body">
    <!-- Search/Filter Area -->
    <div class="card"
        style="display: flex; gap: var(--spacing-md); align-items: center; padding: var(--spacing-sm) var(--spacing-md);">
        <div style="flex: 1;">
            <input type="text" id="mapping-search" class="form-input" placeholder="Search mappings...">
        </div>
    </div>

    <!-- Mapping Table -->
    <div class="card" style="padding: 0; overflow: hidden;">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                    <th class="sortable" data-col="0" onclick="sortByColumn(this)">Mapping Name (Source Table)<i
                            class="fas fa-sort sort-icon"></i></th>
                    <th class="sortable" data-col="1" onclick="sortByColumn(this)">Source Connection<i
                            class="fas fa-sort sort-icon"></i></th>
                    <th class="sortable" data-col="2" onclick="sortByColumn(this)">Target Connection<i
                            class="fas fa-sort sort-icon"></i></th>
                    <th class="sortable" data-col="3" onclick="sortByColumn(this)">Target Table<i
                            class="fas fa-sort sort-icon"></i></th>
                    <th class="sortable" data-col="4" onclick="sortByColumn(this)">Status<i
                            class="fas fa-sort sort-icon"></i></th>
                    <th class="sortable" data-col="5" onclick="sortByColumn(this)">Created At<i
                            class="fas fa-sort sort-icon"></i></th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for mapping in mappings %}
                <tr>
                    <td><input type="checkbox" class="mapping-checkbox" value="{{ mapping.id }}"
                            onchange="updateSelectionButtons()"></td>
                    <td><strong>{{ mapping.source_table }}</strong></td>
                    <td>{{ mapping.source_conn.name }}</td>
                    <td>{{ mapping.target_conn.name }}</td>
                    <td>{{ mapping.target_table }}</td>
                    <td><span class="status-badge status-active">{{ mapping.status }}</span></td>
                    <td>{{ mapping.created_at }}</td>
                    <td>
                        <button class="btn btn-secondary" style="padding: 4px 8px;"
                            onclick="showDdl({{ mapping.id }}, this)" title="Generate DDL"><i
                                class="fas fa-code"></i></button>
                        <button class="btn btn-secondary" style="padding: 4px 8px;"
                            onclick="downloadSingle({{ mapping.id }}, this)" title="Download Excel"><i
                                class="fas fa-file-excel" style="color: #1D6F42;"></i></button>
                        <button class="btn btn-secondary" style="padding: 4px 8px;"
                            onclick="openModal({{ mapping.id }})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-secondary"
                            style="padding: 4px 8px; color: var(--error-color); border-color: var(--error-color);"
                            onclick="deleteMapping({{ mapping.id }})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" style="text-align: center; color: #aaa;">No mappings found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Modal -->
<div id="modal-overlay" class="modal-overlay"></div>
<div id="edit-modal" class="modal-container">
    <div class="modal-header">
        <h3 id="modal-title" style="margin: 0; font-weight: 600;">Mapping Details</h3>
        <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary" onclick="toggleMaximize()"><i class="fas fa-expand"></i></button>
            <button class="btn btn-secondary" onclick="closeModal()"><i class="fas fa-times"></i></button>
        </div>
    </div>
    <div class="modal-body">
        <div
            style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-md);">
            <div>
                <span class="form-label">Source Connection</span>
                <div id="modal-source-conn" style="font-weight: 500;"></div>
            </div>
            <div>
                <span class="form-label">Target Connection</span>
                <div id="modal-target-conn" style="font-weight: 500;"></div>
            </div>
        </div>

        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
            <h4 style="margin: 0;">Column Mappings</h4>
            <input type="text" id="column-search" class="form-input"
                style="width: 250px; padding: 4px 8px; font-size: 13px;"
                placeholder="Search Physical or Logical Name..." onkeyup="filterColumns()">
        </div>
        <div class="column-grid" id="column-grid">
            <!-- Headers -->
            <div class="column-header">Ord</div>
            <div class="column-header">Physical Name</div>
            <div class="column-header">Logical Name</div>
            <div class="column-header">Type</div>
            <div class="column-header" title="Nullable">Null</div>
            <div class="column-header" title="Primary Key">PK</div>
            <div class="column-header" title="Extraction Condition">Ext</div>
            <div class="column-header" title="Partition Key">Part</div>
            <div class="column-header">Trans Rule</div>
            <div class="column-header">Target Col</div>
            <div class="column-header">Target Type</div>
            <div class="column-header"><i class="fas fa-trash"></i></div>
            <!-- Rows will be populated by JS -->
        </div>
        <div style="margin-top: 10px;">
            <button class="btn btn-secondary" onclick="addNewColumn()"><i class="fas fa-plus"></i> Add Column</button>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()" style="margin-right: 8px;">Cancel</button>
        <button class="btn btn-primary" onclick="saveMappingChanges()">Save Changes</button>
    </div>
</div>

<!-- DDL Modal -->
<div id="ddl-modal-overlay" class="modal-overlay"></div>
<div id="ddl-modal" class="modal-container" style="max-height: 600px; max-width: 800px;">
    <div class="modal-header">
        <h3 style="margin: 0; font-weight: 600;">Generated DDL</h3>
        <button class="btn btn-secondary" onclick="closeDdlModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body" style="background: #1e1e1e; color: #d4d4d4;">
        <pre id="ddl-content"
            style="margin: 0; white-space: pre-wrap; font-family: 'Consolas', 'Monaco', monospace; font-size: 14px;"></pre>
    </div>
    <div class="modal-footer" style="justify-content: space-between;">
        <button class="btn btn-secondary" onclick="copyToClipboard()">
            <i class="fas fa-copy"></i> Copy to Clipboard
        </button>
        <button class="btn btn-secondary" onclick="closeDdlModal()">Close</button>
    </div>
</div>

<!-- DAG Generation Modal -->
<div id="dag-modal-overlay" class="modal-overlay"></div>
<div id="dag-modal" class="modal-container"
    style="max-width: 1050px; width: 95%; height: 92vh; display: none; flex-direction: column;">
    <div class="modal-header">
        <h3 style="margin: 0; font-weight: 600;"><i class="fas fa-magic"
                style="color:#e67e22; margin-right:8px;"></i>Generate DAGs</h3>
        <button class="btn btn-secondary" onclick="closeDagModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0;">

        <!-- 1. ÏÑ†ÌÉùÎêú Îß§Ìïë Î™©Î°ù -->
        <div class="dag-modal-section">
            <div class="dag-section-title"><i class="fas fa-list-check"></i> ÏÑ†ÌÉùÎêú Îß§Ìïë</div>
            <div class="mapping-tags-wrap" id="dag-selected-mappings">
                <!-- JSÎ°ú Ï±ÑÏõåÏßê -->
            </div>
        </div>

        <!-- 2. DAG ÌÖúÌîåÎ¶ø -->
        <div class="dag-modal-section">
            <div class="dag-section-title"><i class="fas fa-file-code"></i> DAG ÌÖúÌîåÎ¶ø</div>
            <select class="form-select" id="dag-template-select">
                <option value="" disabled selected>ÌÖúÌîåÎ¶ø ÏÑ†ÌÉù...</option>
            </select>
        </div>

        <!-- 3. DAG ÏÑ§Ï†ï -->
        <div class="dag-modal-section">
            <div class="dag-section-title"><i class="fas fa-cog"></i> DAG ÏÑ§Ï†ï</div>

            <!-- DAG ID Prefix -->
            <div class="form-group" style="margin-bottom: 14px;">
                <label class="form-label" style="font-size:13px;">DAG ID Prefix <span
                        style="color:#666;font-weight:normal;">(ÏÑ†ÌÉù ÏÇ¨Ìï≠)</span></label>
                <input type="text" class="form-input" id="dag-id-prefix" placeholder="Ïòà: etl_, prod_ (ÎØ∏ÏûÖÎ†• Ïãú ÏûêÎèô ÏÉùÏÑ±)"
                    style="font-family: monospace;">
            </div>

            <!-- Ïä§ÏºÄÏ§Ñ -->
            <div class="form-group" style="margin-bottom: 14px;">
                <label class="form-label" style="font-size:13px; margin-bottom:8px; display:block;">Ïä§ÏºÄÏ§Ñ
                    (Schedule)</label>
                <!-- ÌîÑÎ¶¨ÏÖã Î≤ÑÌäº -->
                <div class="schedule-preset-group">
                    <button class="schedule-preset-btn" data-type="daily"
                        onclick="selectSchedulePreset(this, 'daily')">üåÖ Îß§Ïùº</button>
                    <button class="schedule-preset-btn" data-type="weekly"
                        onclick="selectSchedulePreset(this, 'weekly')">üìÖ Îß§Ï£º</button>
                    <button class="schedule-preset-btn" data-type="monthly"
                        onclick="selectSchedulePreset(this, 'monthly')">üóì Îß§Ïõî</button>
                    <button class="schedule-preset-btn" data-type="hourly"
                        onclick="selectSchedulePreset(this, 'hourly')">‚è± Îß§ÏãúÍ∞Ñ</button>
                    <button class="schedule-preset-btn" data-type="once"
                        onclick="selectSchedulePreset(this, 'once')">1Ô∏è‚É£ 1ÌöåÎßå</button>
                    <button class="schedule-preset-btn" data-type="none" onclick="selectSchedulePreset(this, 'none')">üö´
                        Ïä§ÏºÄÏ§Ñ ÏóÜÏùå</button>
                    <button class="schedule-preset-btn" data-type="custom"
                        onclick="selectSchedulePreset(this, 'custom')">‚úèÔ∏è ÏßÅÏ†ë ÏûÖÎ†•</button>
                </div>

                <!-- Îß§Ïùº ÏòµÏÖò -->
                <div class="schedule-detail-box" id="sched-daily" style="display:none;">
                    <div class="schedule-detail-row">
                        <span class="schedule-detail-label">ÏãúÍ∞Ñ</span>
                        <select class="schedule-num-select" id="daily-hour" onchange="updateCronFromUI()">
                            <!-- JSÎ°ú ÏÉùÏÑ± -->
                        </select>
                        <span class="schedule-detail-label" style="margin-left:4px;">Î∂Ñ</span>
                        <select class="schedule-num-select" id="daily-minute" onchange="updateCronFromUI()">
                            <!-- JSÎ°ú ÏÉùÏÑ± -->
                        </select>
                    </div>
                </div>

                <!-- Îß§Ï£º ÏòµÏÖò -->
                <div class="schedule-detail-box" id="sched-weekly" style="display:none;">
                    <div class="schedule-detail-row">
                        <span class="schedule-detail-label">ÏöîÏùº</span>
                        <select class="schedule-num-select" id="weekly-dow" onchange="updateCronFromUI()">
                            <option value="0">ÏùºÏöîÏùº</option>
                            <option value="1">ÏõîÏöîÏùº</option>
                            <option value="2">ÌôîÏöîÏùº</option>
                            <option value="3">ÏàòÏöîÏùº</option>
                            <option value="4">Î™©ÏöîÏùº</option>
                            <option value="5">Í∏àÏöîÏùº</option>
                            <option value="6">ÌÜ†ÏöîÏùº</option>
                        </select>
                    </div>
                    <div class="schedule-detail-row">
                        <span class="schedule-detail-label">ÏãúÍ∞Ñ</span>
                        <select class="schedule-num-select" id="weekly-hour" onchange="updateCronFromUI()"></select>
                        <span class="schedule-detail-label" style="margin-left:4px;">Î∂Ñ</span>
                        <select class="schedule-num-select" id="weekly-minute" onchange="updateCronFromUI()"></select>
                    </div>
                </div>

                <!-- Îß§Ïõî ÏòµÏÖò -->
                <div class="schedule-detail-box" id="sched-monthly" style="display:none;">
                    <div class="schedule-detail-row">
                        <span class="schedule-detail-label">Îß§Ïõî</span>
                        <select class="schedule-num-select" id="monthly-day" onchange="updateCronFromUI()">
                            <!-- JSÎ°ú ÏÉùÏÑ± -->
                        </select>
                        <span class="schedule-detail-label" style="margin-left:2px;">Ïùº</span>
                    </div>
                    <div class="schedule-detail-row">
                        <span class="schedule-detail-label">ÏãúÍ∞Ñ</span>
                        <select class="schedule-num-select" id="monthly-hour" onchange="updateCronFromUI()"></select>
                        <span class="schedule-detail-label" style="margin-left:4px;">Î∂Ñ</span>
                        <select class="schedule-num-select" id="monthly-minute" onchange="updateCronFromUI()"></select>
                    </div>
                </div>

                <!-- Îß§ÏãúÍ∞Ñ ÏòµÏÖò -->
                <div class="schedule-detail-box" id="sched-hourly" style="display:none;">
                    <div class="schedule-detail-row">
                        <span class="schedule-detail-label">Î∂Ñ</span>
                        <select class="schedule-num-select" id="hourly-minute" onchange="updateCronFromUI()"></select>
                        <span class="schedule-detail-label" style="margin-left:4px;">Î∂ÑÏóê Ïã§Ìñâ</span>
                    </div>
                </div>

                <!-- ÏßÅÏ†ë ÏûÖÎ†• -->
                <div class="schedule-detail-box" id="sched-custom" style="display:none;">
                    <div style="margin-bottom:6px; font-size:12px; color:#aaa;">ÌÅ¨Î°† ÌëúÌòÑÏãù ÏßÅÏ†ë ÏûÖÎ†• (Î∂Ñ Ïãú Ïùº Ïõî ÏöîÏùº)</div>
                    <input type="text" class="custom-cron-input" id="custom-cron-input"
                        placeholder="Ïòà: 0 2 * * *  ÎòêÎäî  0 9 * * 1" oninput="updateCronFromCustomInput()">
                </div>

                <!-- ÌÅ¨Î°† Í≤∞Í≥º ÌëúÏãú (ÌîÑÎ¶¨ÏÖã ÏóÜÏùå/@once Ï†úÏô∏) -->
                <div class="cron-result-box" id="cron-result-box" style="display:none;">
                    <div>
                        <div style="font-size:11px; color:#666; margin-bottom:2px;">Cron Expression</div>
                        <div class="cron-expr-display" id="cron-expr-display"></div>
                    </div>
                    <div class="cron-desc-display" id="cron-desc-display"></div>
                </div>
            </div>

            <!-- Catchup -->
            <div class="form-group">
                <label class="form-label" style="font-size:13px; margin-bottom:8px; display:block;">Catchup</label>
                <div class="catchup-toggle-group">
                    <button class="catchup-toggle-btn" id="catchup-off-btn" onclick="setCatchup(false)">OFF</button>
                    <button class="catchup-toggle-btn" id="catchup-on-btn" onclick="setCatchup(true)">ON</button>
                </div>
                <div style="font-size:11px; color:#666; margin-top:5px;" id="catchup-desc">Í≥ºÍ±∞ ÎØ∏Ïã§Ìñâ DAGÎ•º ÏÜåÍ∏â Ïã§ÌñâÌïòÏßÄ ÏïäÏäµÎãàÎã§.
                </div>
            </div>
        </div>

        <!-- Preview ÏòÅÏó≠ -->
        <div id="dag-preview-area"
            style="display: none; padding: 0 var(--spacing-md); flex-direction: column; max-height: 380px; overflow-y: auto; flex-shrink: 0; border-top: 1px solid var(--border-color); margin-top: 4px;">
            <h4
                style="margin: 10px 0 6px; color: var(--text-primary); font-size:14px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; background:var(--card-bg); z-index:1; padding:8px 0;">
                <span><i class="fas fa-database" style="color:#4cc9f0; margin-right:6px;"></i>Preview SQL</span>
                <span style="font-size:11px; font-weight:normal; color:var(--text-secondary);">ÏÑ†ÌÉùÎêú Îß§Ìïë Í∏∞Î∞òÏúºÎ°ú ÏÉùÏÑ±</span>
            </h4>
            <div id="preview-content"
                style="background: transparent; font-family: monospace; font-size: 12px; padding-bottom:12px;">
            </div>
        </div>

    </div><!-- /modal-body -->

    <!-- Í≤∞Í≥º Î©îÏãúÏßÄ ÏòÅÏó≠ (footer Î∞îÎ°ú ÏúÑ) -->
    <div id="dag-result-message" class="alert"
        style="display: none; margin: 0 var(--spacing-md) 0; border-radius: 6px; font-size:13px; line-height:1.5;">
    </div>

    <!-- Ìï≠ÏÉÅ ÌïòÎã®Ïóê Í≥†Ï†ïÎêòÎäî footer -->
    <div class="modal-footer" style="justify-content: flex-end; align-items: center; flex-shrink: 0; gap: 8px;">
        <button class="btn btn-secondary" onclick="previewSql()"><i class="fas fa-eye"></i> Preview SQL</button>
        <button class="btn btn-secondary" onclick="closeDagModal()">Ï∑®ÏÜå</button>
        <button type="button" class="btn btn-primary" onclick="generateDags(this)"><i class="fas fa-play"></i>
            Generate</button>
    </div>
</div><!-- /dag-modal -->

<!-- Advanced Sort Modal -->
<div id="advSortModal">
    <div class="adv-sort-box">
        <h3><i class="fas fa-sort-amount-down" style="color:#4cc9f0"></i> Í≥†Í∏â Ï†ïÎ†¨</h3>
        <div id="advSortRows"></div>
        <button class="adv-sort-add" onclick="addAdvSortRow()"><i class="fas fa-plus"></i> Ï†ïÎ†¨ Í∏∞Ï§Ä Ï∂îÍ∞Ä</button>
        <div class="adv-sort-footer">
            <button class="btn" style="background:#333; color:#aaa; border:1px solid #555;"
                onclick="closeAdvSort()">Ï∑®ÏÜå</button>
            <button class="btn btn-primary" onclick="applyAdvSort()"><i class="fas fa-check"></i> Ï†ÅÏö©</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    /* ========== SORT LOGIC ========== */
    const COL_NAMES = ['Mapping Name', 'Source Connection', 'Target Connection', 'Target Table', 'Status', 'Created At'];
    // td index: checkbox=0, mapping_name=1, src_conn=2, tgt_conn=3, tgt_table=4, status=5, created_at=6, actions=7
    const TD_INDEX = [1, 2, 3, 4, 5, 6];

    let singleSortCol = null;
    let advSortCriteria = [];
    let isAdvMode = false;

    function sortByColumn(th) {
        const colIdx = parseInt(th.dataset.col);
        if (singleSortCol && singleSortCol.colIdx === colIdx) {
            singleSortCol.dir = singleSortCol.dir === 'asc' ? 'desc' : 'asc';
        } else {
            singleSortCol = { colIdx, dir: 'asc' };
        }
        isAdvMode = false;
        advSortCriteria = [];
        applySort([singleSortCol]);
        updateSortHeaders([singleSortCol]);
    }

    function applySort(criteria) {
        const tbody = document.querySelector('.data-table tbody');
        const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => r.cells.length > 2);
        rows.sort((a, b) => {
            for (const { colIdx, dir } of criteria) {
                const tdIdx = TD_INDEX[colIdx];
                const aText = (a.cells[tdIdx]?.innerText || '').trim();
                const bText = (b.cells[tdIdx]?.innerText || '').trim();
                const aDate = Date.parse(aText);
                const bDate = Date.parse(bText);
                let cmp;
                if (!isNaN(aDate) && !isNaN(bDate)) {
                    cmp = aDate - bDate;
                } else {
                    cmp = aText.localeCompare(bText, undefined, { numeric: true, sensitivity: 'base' });
                }
                if (cmp !== 0) return dir === 'asc' ? cmp : -cmp;
            }
            return 0;
        });
        rows.forEach(r => tbody.appendChild(r));
    }

    function updateSortHeaders(criteria) {
        document.querySelectorAll('.data-table thead th.sortable').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
            const icon = th.querySelector('.sort-icon');
            const badge = th.querySelector('.sort-badge');
            if (badge) badge.remove();
            if (icon) icon.className = 'fas fa-sort sort-icon';
        });
        criteria.forEach((c, i) => {
            const th = document.querySelector(`.data-table thead th[data-col="${c.colIdx}"]`);
            if (!th) return;
            th.classList.add(c.dir === 'asc' ? 'sort-asc' : 'sort-desc');
            const icon = th.querySelector('.sort-icon');
            if (icon) icon.className = `fas fa-sort-${c.dir === 'asc' ? 'up' : 'down'} sort-icon`;
            if (criteria.length > 1) {
                const badge = document.createElement('span');
                badge.className = 'sort-badge';
                badge.textContent = i + 1;
                th.insertBefore(badge, icon);
            }
        });
    }

    function openAdvSort() {
        if (isAdvMode && advSortCriteria.length > 0) {
            renderAdvRows(advSortCriteria);
        } else if (singleSortCol) {
            renderAdvRows([singleSortCol]);
        } else {
            renderAdvRows([{ colIdx: 0, dir: 'asc' }]);
        }
        document.getElementById('advSortModal').classList.add('open');
    }

    function closeAdvSort() {
        document.getElementById('advSortModal').classList.remove('open');
    }

    function renderAdvRows(criteria) {
        const container = document.getElementById('advSortRows');
        container.innerHTML = '';
        criteria.forEach(c => addAdvSortRow(c.colIdx, c.dir));
    }

    function addAdvSortRow(colIdx = 0, dir = 'asc') {
        const container = document.getElementById('advSortRows');
        const row = document.createElement('div');
        row.className = 'adv-sort-row';
        row.innerHTML = `
            <span class="adv-sort-drag-handle"><i class="fas fa-grip-vertical"></i></span>
            <select class="adv-sort-col">
                ${COL_NAMES.map((n, i) => `<option value="${i}" ${i == colIdx ? 'selected' : ''}>${n}</option>`).join('')}
            </select>
            <select class="adv-sort-dir">
                <option value="asc" ${dir === 'asc' ? 'selected' : ''}>Ïò§Î¶ÑÏ∞®Ïàú ‚Üë</option>
                <option value="desc" ${dir === 'desc' ? 'selected' : ''}>ÎÇ¥Î¶ºÏ∞®Ïàú ‚Üì</option>
            </select>
            <button class="adv-sort-remove" onclick="this.closest('.adv-sort-row').remove()" title="ÏÇ≠Ï†ú"><i class="fas fa-times"></i></button>
        `;
        container.appendChild(row);
    }

    function applyAdvSort() {
        const rows = document.querySelectorAll('#advSortRows .adv-sort-row');
        if (rows.length === 0) { closeAdvSort(); return; }
        advSortCriteria = Array.from(rows).map(row => ({
            colIdx: parseInt(row.querySelector('.adv-sort-col').value),
            dir: row.querySelector('.adv-sort-dir').value
        }));
        isAdvMode = true;
        singleSortCol = null;
        applySort(advSortCriteria);
        updateSortHeaders(advSortCriteria);
        closeAdvSort();
    }

    document.getElementById('advSortModal').addEventListener('click', function (e) {
        if (e.target === this) closeAdvSort();
    });

    /* ========== ORIGINAL FUNCTIONS ========== */
    const modalOverlay = document.getElementById('modal-overlay');
    const editModal = document.getElementById('edit-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalSourceConn = document.getElementById('modal-source-conn');
    const modalTargetConn = document.getElementById('modal-target-conn');
    const columnGrid = document.getElementById('column-grid');
    const columnSearch = document.getElementById('column-search');

    // Mapping List Search
    const mappingSearch = document.getElementById('mapping-search');
    if (mappingSearch) {
        mappingSearch.addEventListener('input', function () {
            const filter = this.value.toUpperCase();
            const table = document.querySelector('.data-table');
            const rows = table.getElementsByTagName('tr');

            // Start from 1 to skip header
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                // Skip "No mappings found" row if it exists (usually has colspan)
                if (row.cells.length < 2) continue;

                // Column 1 is Mapping Name (Source Table)
                const mappingNameCell = row.cells[1];
                const targetTableCell = row.cells[4]; // Also search target table

                if (mappingNameCell || targetTableCell) {
                    const mappingName = mappingNameCell ? mappingNameCell.textContent || mappingNameCell.innerText : "";
                    const targetName = targetTableCell ? targetTableCell.textContent || targetTableCell.innerText : "";

                    if (mappingName.toUpperCase().indexOf(filter) > -1 || targetName.toUpperCase().indexOf(filter) > -1) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                }
            }
        });
    }

    let currentMappingId = null;

    function openModal(id) {
        currentMappingId = id;
        fetch(`/admin/mappings/api/detail/${id}`)
            .then(response => response.json())
            .then(data => {
                let titleText = `${data.source_table} \u2192 ${data.target_table}`;
                if (data.source_table_desc) {
                    titleText += `  \u2014  ${data.source_table_desc}`;
                }
                modalTitle.innerText = titleText;
                modalSourceConn.innerText = data.source_conn;
                modalTargetConn.innerText = data.target_conn;
                columnSearch.value = ''; // Reset search

                // Clear existing rows
                const rows = columnGrid.querySelectorAll('.column-row');
                rows.forEach(row => row.remove());

                data.columns.sort((a, b) => a.column_order - b.column_order).forEach(col => {
                    renderColumnRow(col);
                });

                modalOverlay.style.display = 'block';
                editModal.style.display = 'flex';
            });
    }

    function renderColumnRow(col = {}) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'column-row';
        rowDiv.style.display = 'contents';
        rowDiv.dataset.id = col.id || ''; // Empty for new cols

        // Order
        addInputCell(rowDiv, col.column_order || '', 'number');
        // Physical Name
        addInputCell(rowDiv, col.source_column || '');
        // Logical Name (with column COMMENTS as tooltip)
        const logicalCell = addInputCell(rowDiv, col.target_logical_name || '');
        if (col.source_column_desc) {
            const input = logicalCell.querySelector('input');
            if (input) input.title = col.source_column_desc;
        }
        // Type
        addInputCell(rowDiv, col.source_type || '');
        // Null
        addCheckboxCell(rowDiv, col.is_nullable !== false); // Default true
        // PK
        addCheckboxCell(rowDiv, col.is_pk || false);
        // Extraction Condition
        addCheckboxCell(rowDiv, col.is_extraction_condition || false);
        // Partition
        addCheckboxCell(rowDiv, col.is_partition || false);
        // Trans Rule
        addInputCell(rowDiv, col.trans_rule || '');
        // Target Column
        addInputCell(rowDiv, col.target_column || '');
        // Target Type
        addInputCell(rowDiv, col.target_type || '');
        // Delete Action
        addDeleteCell(rowDiv);

        columnGrid.appendChild(rowDiv);
    }

    function addNewColumn() {
        // Calculate next order
        const rows = columnGrid.querySelectorAll('.column-row');
        let nextOrder = 1;
        if (rows.length > 0) {
            const lastRow = rows[rows.length - 1];
            const orderInput = lastRow.children[0].querySelector('input');
            if (orderInput && orderInput.value) {
                nextOrder = parseInt(orderInput.value) + 1;
            }
        }
        renderColumnRow({ column_order: nextOrder });
    }

    function saveMappingChanges() {
        if (!currentMappingId) return;

        const rows = columnGrid.querySelectorAll('.column-row');
        const columnsData = [];

        rows.forEach(row => {
            const inputs = row.querySelectorAll('input');
            // inputs order: order, source_col, logical_name, source_type, null(cb), pk(cb), ext(cb), part(cb), trans, target_col, target_type
            // Note: querySelectorAll returns in document order.

            columnsData.push({
                id: row.dataset.id ? parseInt(row.dataset.id) : null, // Integer ID or null for new columns
                column_order: parseInt(inputs[0].value) || 0,
                source_column: inputs[1].value,
                target_logical_name: inputs[2].value,
                source_type: inputs[3].value,
                is_nullable: inputs[4].checked,
                is_pk: inputs[5].checked,
                is_extraction_condition: inputs[6].checked,
                is_partition: inputs[7].checked,
                trans_rule: inputs[8].value,
                target_column: inputs[9].value,
                target_type: inputs[10].value
            });
        });

        const btn = document.querySelector('#edit-modal .btn-primary');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;

        fetch(`/api/mappings/${currentMappingId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ columns: columnsData })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Mapping updated successfully!');
                    closeModal();
                    // Optionally reload table or partial update
                } else {
                    alert('Error saving mapping: ' + data.message);
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('An error occurred while saving.');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }

    function addInputCell(parent, value, type = 'text') {
        const div = document.createElement('div');
        div.className = 'column-cell';
        const input = document.createElement('input');
        input.type = type;
        input.value = value;
        div.appendChild(input);
        parent.appendChild(div);
        return div;
    }

    function addCheckboxCell(parent, isChecked) {
        const div = document.createElement('div');
        div.className = 'column-cell';
        div.style.justifyContent = 'center';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = isChecked;
        input.style.width = 'auto'; // Reset width for checkbox
        div.appendChild(input);
        parent.appendChild(div);
    }

    function addDeleteCell(parent) {
        const div = document.createElement('div');
        div.className = 'column-cell';
        div.style.justifyContent = 'center';
        div.style.cursor = 'pointer';
        div.innerHTML = '<i class="fas fa-times" style="color: var(--error-color);"></i>';
        div.onclick = function () {
            parent.remove();
        };
        parent.appendChild(div);
    }

    function filterColumns() {
        const filter = columnSearch.value.toUpperCase();
        const rows = columnGrid.querySelectorAll('.column-row');

        rows.forEach(row => {
            const physicalNameInput = row.children[1].querySelector('input');
            const logicalNameInput = row.children[2].querySelector('input');

            const physicalName = physicalNameInput ? physicalNameInput.value.toUpperCase() : '';
            const logicalName = logicalNameInput ? logicalNameInput.value.toUpperCase() : '';

            if (physicalName.indexOf(filter) > -1 || logicalName.indexOf(filter) > -1) {
                row.style.display = 'contents';
            } else {
                row.style.display = 'none';
            }
        });
    }



    function closeModal() {
        modalOverlay.style.display = 'none';
        editModal.style.display = 'none';
        editModal.classList.remove('maximized');
    }

    function toggleMaximize() {
        editModal.classList.toggle('maximized');
    }

    function deleteMapping(id) {
        if (confirm('Are you sure you want to delete this mapping?')) {
            fetch(`/admin/mappings/delete/${id}`, {
                method: 'POST'
            })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete mapping.');
                    }
                })
                .catch(error => {
                    alert('An error occurred during deletion.');
                    console.error('Error:', error);
                });
        }
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.mapping-checkbox');
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
        updateSelectionButtons();
    }

    function updateSelectionButtons() {
        const checked = document.querySelectorAll('.mapping-checkbox:checked');
        const allCheckboxes = document.querySelectorAll('.mapping-checkbox');
        const selectAll = document.getElementById('selectAll');
        const bulkDownloadBtn = document.getElementById('bulkDownloadBtn');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        const generateDagBtn = document.getElementById('generateDagBtn');

        if (checked.length > 0) {
            bulkDownloadBtn.style.display = 'inline-flex';
            bulkDownloadBtn.querySelector('.btn-icon-right').textContent = `Bulk Download (${checked.length})`;
            bulkDeleteBtn.style.display = 'inline-flex';
            bulkDeleteBtn.querySelector('.btn-icon-right').textContent = `Bulk Delete (${checked.length})`;
            generateDagBtn.style.display = 'inline-flex';
            generateDagBtn.querySelector('.btn-icon-right').textContent = `Generate DAG (${checked.length})`;
        } else {
            bulkDownloadBtn.style.display = 'none';
            bulkDeleteBtn.style.display = 'none';
            generateDagBtn.style.display = 'none';
        }

        // Update select all checkbox state
        if (checked.length === allCheckboxes.length && allCheckboxes.length > 0) {
            selectAll.checked = true;
            selectAll.indeterminate = false;
        } else if (checked.length > 0) {
            selectAll.checked = false;
            selectAll.indeterminate = true;
        } else {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        }
    }

    function bulkDeleteMappings(btn) {
        const checkboxes = document.querySelectorAll('.mapping-checkbox:checked');
        const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

        if (ids.length === 0) {
            alert('Please select at least one mapping to delete.');
            return;
        }

        if (!confirm(`Are you sure you want to delete ${ids.length} mapping(s)? This action cannot be undone.`)) {
            return;
        }

        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

        fetch('/api/mappings/bulk_delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mapping_ids: ids })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' || data.status === 'partial_success') {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during bulk deletion.');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            });
    }

    function downloadSelected(btn) {
        const checkboxes = document.querySelectorAll('.mapping-checkbox:checked');
        const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

        if (ids.length === 0) {
            alert('Please select at least one mapping to download.');
            return;
        }

        downloadExcel(ids, btn);
    }

    function downloadSingle(id, btn) {
        downloadExcel([id], btn);
    }

    function downloadExcel(ids, buttonElement) {
        const originalContent = buttonElement ? buttonElement.innerHTML : '';
        if (buttonElement) {
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
        }

        fetch('/admin/mappings/download_excel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ mapping_ids: ids })
        })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(err => { throw new Error(err.message || 'Download failed'); });
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'mapping_definitions.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                alert('Error downloading Excel: ' + error.message);
                console.error('Error:', error);
            })
            .finally(() => {
                if (buttonElement) {
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = originalContent;
                }
            });
    }

    // DDL Modal Logic
    const ddlModalOverlay = document.getElementById('ddl-modal-overlay');
    const ddlModal = document.getElementById('ddl-modal');
    const ddlContent = document.getElementById('ddl-content');

    function showDdl(id, btn) {
        const originalIcon = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        fetch(`/admin/mappings/generate_ddl/${id}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    ddlContent.innerText = data.ddl;
                    ddlModalOverlay.style.display = 'block';
                    ddlModal.style.display = 'flex';
                } else {
                    alert('Error generating DDL: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while generating DDL.');
            })
            .finally(() => {
                btn.innerHTML = originalIcon;
                btn.disabled = false;
            });
    }

    function closeDdlModal() {
        ddlModalOverlay.style.display = 'none';
        ddlModal.style.display = 'none';
    }

    function copyToClipboard() {
        const text = ddlContent.innerText;
        navigator.clipboard.writeText(text).then(() => {
            alert('DDL copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy: ', err);
            alert('Failed to copy to clipboard.');
        });
    }

    // ========== DAG Generation Logic ==========
    const dagModalOverlay = document.getElementById('dag-modal-overlay');
    const dagModal = document.getElementById('dag-modal');
    const dagTemplateSelect = document.getElementById('dag-template-select');
    const dagResult = document.getElementById('dag-result-message');

    // ÌòÑÏû¨ Îß§Ìïë ÌñâÏóêÏÑú ÌÖçÏä§Ìä∏ Ï†ïÎ≥¥ Ï∂îÏ∂ú (Ï≤¥ÌÅ¨Î∞ïÏä§ value = id, td[1]=sourcetable, td[4]=targettable)
    function getCheckedMappingInfos() {
        const rows = document.querySelectorAll('.mapping-checkbox:checked');
        return Array.from(rows).map(cb => {
            const tr = cb.closest('tr');
            const cells = tr ? tr.querySelectorAll('td') : [];
            const sourceTable = cells[1] ? cells[1].innerText.trim() : cb.value;
            const targetTable = cells[4] ? cells[4].innerText.trim() : '';
            return { id: parseInt(cb.value), sourceTable, targetTable };
        });
    }

    // ===== Ïä§ÏºÄÏ§Ñ UI ÏÉÅÌÉú =====
    let _currentScheduleType = null; // 'daily','weekly','monthly','hourly','once','none','custom'
    let _catchupValue = false;

    function _fillSelect(el, options) {
        // options: Î∞∞Ïó¥ [{value, label}] ÎòêÎäî Ïà´Ïûê Î≤îÏúÑ [start, end]
        el.innerHTML = '';
        options.forEach(o => {
            const opt = document.createElement('option');
            opt.value = o.value !== undefined ? o.value : o;
            opt.textContent = o.label !== undefined ? o.label : String(o).padStart(2, '0');
            el.appendChild(opt);
        });
    }

    function _initScheduleSelects() {
        // Ïãú/Î∂Ñ ÏòµÏÖò ÏÉùÏÑ±
        const hours = Array.from({ length: 24 }, (_, i) => ({ value: i, label: String(i).padStart(2, '0') + 'Ïãú' }));
        const minutes = Array.from({ length: 60 }, (_, i) => ({ value: i, label: String(i).padStart(2, '0') + 'Î∂Ñ' }));
        const days = Array.from({ length: 31 }, (_, i) => ({ value: i + 1, label: String(i + 1) + 'Ïùº' }));
        const minutesShort = Array.from({ length: 60 }, (_, i) => ({ value: i, label: String(i).padStart(2, '0') }));

        _fillSelect(document.getElementById('daily-hour'), hours);
        _fillSelect(document.getElementById('daily-minute'), minutes);
        _fillSelect(document.getElementById('weekly-hour'), hours);
        _fillSelect(document.getElementById('weekly-minute'), minutes);
        _fillSelect(document.getElementById('monthly-day'), days);
        _fillSelect(document.getElementById('monthly-hour'), hours);
        _fillSelect(document.getElementById('monthly-minute'), minutes);
        _fillSelect(document.getElementById('hourly-minute'), minutesShort);

        // Í∏∞Î≥∏Í∞í: Îß§Ïùº Ïò§Ï†Ñ 2Ïãú 0Î∂Ñ
        document.getElementById('daily-hour').value = 2;
        document.getElementById('daily-minute').value = 0;
    }

    function selectSchedulePreset(btn, type) {
        _currentScheduleType = type;
        // Î≤ÑÌäº active ÏÉÅÌÉú
        document.querySelectorAll('.schedule-preset-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // ÏÉÅÏÑ∏ ÏòÅÏó≠ Ïà®Í∏∞Í∏∞
        ['daily', 'weekly', 'monthly', 'hourly', 'custom'].forEach(t => {
            document.getElementById('sched-' + t).style.display = 'none';
        });
        document.getElementById('cron-result-box').style.display = 'none';

        if (type === 'once' || type === 'none') {
            // Î≥ÑÎèÑ ÏÉÅÏÑ∏ ÏóÜÏùå
            return;
        }

        document.getElementById('sched-' + type).style.display = 'block';
        if (type !== 'custom') {
            updateCronFromUI();
        }
    }

    function updateCronFromUI() {
        if (!_currentScheduleType) return;
        let expr = '', desc = '';

        if (_currentScheduleType === 'daily') {
            const h = document.getElementById('daily-hour').value;
            const m = document.getElementById('daily-minute').value;
            expr = `${m} ${h} * * *`;
            desc = `Îß§Ïùº ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')} Ïã§Ìñâ`;
        } else if (_currentScheduleType === 'weekly') {
            const dow = document.getElementById('weekly-dow').value;
            const h = document.getElementById('weekly-hour').value;
            const m = document.getElementById('weekly-minute').value;
            const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
            expr = `${m} ${h} * * ${dow}`;
            desc = `Îß§Ï£º ${days[dow]}ÏöîÏùº ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')} Ïã§Ìñâ`;
        } else if (_currentScheduleType === 'monthly') {
            const day = document.getElementById('monthly-day').value;
            const h = document.getElementById('monthly-hour').value;
            const m = document.getElementById('monthly-minute').value;
            expr = `${m} ${h} ${day} * *`;
            desc = `Îß§Ïõî ${day}Ïùº ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')} Ïã§Ìñâ`;
        } else if (_currentScheduleType === 'hourly') {
            const m = document.getElementById('hourly-minute').value;
            expr = `${m} * * * *`;
            desc = `Îß§ÏãúÍ∞Ñ ${String(m).padStart(2, '0')}Î∂ÑÏóê Ïã§Ìñâ`;
        }

        if (expr) {
            document.getElementById('cron-expr-display').textContent = expr;
            document.getElementById('cron-desc-display').textContent = desc;
            document.getElementById('cron-result-box').style.display = 'flex';
        }
    }

    function updateCronFromCustomInput() {
        const val = document.getElementById('custom-cron-input').value.trim();
        if (!val) {
            document.getElementById('cron-result-box').style.display = 'none';
            return;
        }
        // Í∞ÑÎã® ÌååÏã±: 5 ÌååÌä∏ ÌÅ¨Î°† ÌëúÌòÑÏãù ÏÑ§Î™Ö
        const parts = val.split(/\s+/);
        let desc = '';
        if (parts.length === 5) {
            const [m, h, dom, mon, dow] = parts;
            if (h !== '*' && m !== '*') desc = `${h.padStart ? h : h}:${m.padStart ? m : m} Ïóê Ïã§Ìñâ`;
            if (dom !== '*') desc = `Îß§Ïõî ${dom}Ïùº ` + desc;
            if (dow !== '*') { const dk = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†']; desc = `Îß§Ï£º ${dk[parseInt(dow)] || dow}ÏöîÏùº ` + desc; }
            if (mon !== '*') desc = `${mon}ÏõîÎßàÎã§ ` + desc;
            if (h === '*') desc = `Îß§ÏãúÍ∞Ñ ${m}Î∂Ñ Ïã§Ìñâ`;
        }
        document.getElementById('cron-expr-display').textContent = val;
        document.getElementById('cron-desc-display').textContent = desc || 'Ïú†Ìö®Ìïú ÌÅ¨Î°† ÌëúÌòÑÏãù';
        document.getElementById('cron-result-box').style.display = 'flex';
    }

    function getScheduleInterval() {
        if (!_currentScheduleType) return null;
        if (_currentScheduleType === 'none') return 'None';
        if (_currentScheduleType === 'once') return '@once';
        if (_currentScheduleType === 'custom') {
            return document.getElementById('custom-cron-input').value.trim() || null;
        }
        return document.getElementById('cron-expr-display').textContent.trim() || null;
    }

    function setCatchup(val) {
        _catchupValue = val;
        const onBtn = document.getElementById('catchup-on-btn');
        const offBtn = document.getElementById('catchup-off-btn');
        const desc = document.getElementById('catchup-desc');
        onBtn.className = val ? 'catchup-toggle-btn active-on' : 'catchup-toggle-btn';
        offBtn.className = val ? 'catchup-toggle-btn' : 'catchup-toggle-btn active-off';
        desc.textContent = val
            ? 'Í≥ºÍ±∞ ÎØ∏Ïã§Ìñâ DAGÎ•º ÏÜåÍ∏â Ïã§ÌñâÌï©ÎãàÎã§.'
            : 'Í≥ºÍ±∞ ÎØ∏Ïã§Ìñâ DAGÎ•º ÏÜåÍ∏â Ïã§ÌñâÌïòÏßÄ ÏïäÏäµÎãàÎã§.';
    }

    function openGenerateModal() {
        const mappingInfos = getCheckedMappingInfos();
        if (mappingInfos.length === 0) {
            alert('Îß§ÌïëÏùÑ ÌïòÎÇò Ïù¥ÏÉÅ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
            return;
        }

        // ÏÑ†ÌÉùÎêú Îß§Ìïë Î±ÉÏßÄ ÌëúÏãú
        const tagsWrap = document.getElementById('dag-selected-mappings');
        tagsWrap.innerHTML = mappingInfos.map(m => {
            const label = m.targetTable ? `${m.sourceTable} ‚Üí ${m.targetTable}` : m.sourceTable;
            return `<span class="mapping-tag" title="ID: ${m.id}">${label}</span>`;
        }).join('');

        // ÌÅ¨Î°† UI Ï¥àÍ∏∞Ìôî
        _initScheduleSelects();
        _currentScheduleType = null;
        _catchupValue = false;
        document.querySelectorAll('.schedule-preset-btn').forEach(b => b.classList.remove('active'));
        ['daily', 'weekly', 'monthly', 'hourly', 'custom'].forEach(t => {
            document.getElementById('sched-' + t).style.display = 'none';
        });
        document.getElementById('cron-result-box').style.display = 'none';
        document.getElementById('custom-cron-input').value = '';
        document.getElementById('dag-id-prefix').value = '';
        setCatchup(false);

        // ÌÖúÌîåÎ¶ø Î°úÎìú
        fetch('/api/templates')
            .then(r => r.json())
            .then(templates => {
                dagTemplateSelect.innerHTML = '<option value="" disabled selected>ÌÖúÌîåÎ¶ø ÏÑ†ÌÉù...</option>';
                templates.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.textContent = t.name;
                    dagTemplateSelect.appendChild(opt);
                });
                dagResult.style.display = 'none';
                dagResult.innerHTML = '';
                document.getElementById('dag-preview-area').style.display = 'none';
                dagModalOverlay.style.display = 'block';
                dagModal.style.display = 'flex';
            })
            .catch(err => {
                console.error('Error loading templates:', err);
                alert('ÌÖúÌîåÎ¶ø Î°úÎìú Ïã§Ìå®.');
            });
    }

    function closeDagModal() {
        dagModalOverlay.style.display = 'none';
        dagModal.style.display = 'none';
    }

    function generateDags(btn) {
        const templateId = dagTemplateSelect.value;
        if (!templateId) {
            alert('ÌÖúÌîåÎ¶øÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
            return;
        }

        const mappingInfos = getCheckedMappingInfos();
        const mappingIds = mappingInfos.map(m => m.id);

        const dagIdPrefix = document.getElementById('dag-id-prefix').value.trim();
        const scheduleInterval = getScheduleInterval();
        const catchup = _catchupValue;

        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        btn.disabled = true;

        fetch('/api/dags/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                template_id: templateId,
                mapping_ids: mappingIds,
                dag_id_prefix: dagIdPrefix || null,
                schedule_interval: scheduleInterval,
                catchup: catchup
            })
        })
            .then(async response => {
                const isJson = response.headers.get('content-type')?.includes('application/json');
                const data = isJson ? await response.json() : null;
                if (!response.ok) {
                    const error = (data && data.message) || response.statusText;
                    return Promise.reject(error);
                }
                return data;
            })
            .then(data => {
                dagResult.style.display = 'block';
                if (data.status === 'success') {
                    dagResult.className = 'alert alert-success';
                    let fileList = '';
                    if (data.generated_files && data.generated_files.length > 0) {
                        fileList = '<ul style="margin-top:8px; font-size:13px;">' +
                            data.generated_files.map(f => `<li>${f}</li>`).join('') + '</ul>';
                    }
                    dagResult.innerHTML = `<i class="fas fa-check-circle"></i> ${data.message} ${fileList}`;
                } else {
                    dagResult.className = 'alert alert-error';
                    dagResult.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error: ${data.message}`;
                }
            })
            .catch(err => {
                console.error('Error generating DAGs:', err);
                dagResult.style.display = 'block';
                dagResult.className = 'alert alert-error';
                const msg = (typeof err === 'string') ? err : (err.message || 'Unknown Error');
                dagResult.innerHTML = `<i class="fas fa-exclamation-circle"></i> Unexpected Error: ${msg}`;
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }

    function previewSql() {
        const selectedIds = Array.from(document.querySelectorAll('.mapping-checkbox:checked')).map(cb => cb.value);
        const previewArea = document.getElementById('dag-preview-area');
        const previewContent = document.getElementById('preview-content');

        if (selectedIds.length === 0) {
            alert('Îß§ÌïëÏùÑ ÌïòÎÇò Ïù¥ÏÉÅ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
            return;
        }

        previewContent.innerHTML = 'Loading preview...';
        previewArea.style.display = 'flex';

        fetch('/api/dags/preview', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mapping_ids: selectedIds })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    let html = '';
                    data.previews.forEach((p, index) => {
                        const sqlId = `sql-preview-${index}`;
                        html += `
                        <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 10px; overflow: hidden;">
                            <div style="padding: 6px 12px; background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--border-color); font-weight: 600; font-size: 12px; display:flex; align-items:center; justify-content:space-between;">
                                <div><span style="color:var(--primary-color); margin-right:6px;">#${index + 1}</span>${p.mapping_name}</div>
                                <button class="btn btn-secondary" style="padding:2px 8px; font-size:11px;" onclick="copyPreviewSql('${sqlId}')"><i class="fas fa-copy"></i> Copy</button>
                            </div>
                            <pre id="${sqlId}" style="margin:0; padding:10px 12px; background:#1e1e1e; color:#d4d4d4; white-space:pre-wrap; word-break:break-all; font-family:monospace; font-size:12px; line-height:1.5;">${p.source_sql}</pre>
                        </div>`;
                    });
                    previewContent.innerHTML = html;
                } else {
                    previewContent.innerHTML = `<span style="color:var(--error-color);">Error: ${data.message}</span>`;
                }
            })
            .catch(err => {
                previewContent.innerHTML = `<span style="color:var(--error-color);">Error: ${err.message}</span>`;
            });
    }

    function copyPreviewSql(elementId) {
        const text = document.getElementById(elementId).textContent;
        navigator.clipboard.writeText(text).then(() => {
            alert('SQL copied to clipboard!');
        }).catch(err => {
            alert('Failed to copy SQL.');
        });
    }
</script>
{% endblock %}
```