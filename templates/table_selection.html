{% extends 'base.html' %}

{% block title %}Toy Airflow - Table Selection{% endblock %}

{% block content %}
<header class="page-header">
    <div style="display: flex; align-items: center;">
        <a href="{{ url_for('mappings.index') }}" class="btn btn-secondary" style="margin-right: 16px;">
            <i class="fas fa-arrow-left"></i>
        </a>
        <h1 class="page-title">New Mapping: Select Tables</h1>
    </div>
    <div>
        <button class="btn btn-primary" onclick="generateMapping()">Generate Mapping <i
                class="fas fa-arrow-right btn-icon-right"></i></button>
    </div>
</header>

<div class="content-body">
    <!-- Connection Selection -->
    <div class="card" style="margin-bottom: var(--spacing-md);">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
            <div class="form-group">
                <label class="form-label">Source Connection</label>
                <select id="source-conn" class="form-select">
                    <option value="">Select Connection...</option>
                    {% for conn in connections %}
                    <option value="{{ conn.id }}">{{ conn.name }} ({{ conn.conn_type }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Target Connection</label>
                <select id="target-conn" class="form-select">
                    <option value="">Select Connection...</option>
                    {% for conn in connections %}
                    <option value="{{ conn.id }}">{{ conn.name }} ({{ conn.conn_type }})</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Table Selection (Dual List) -->
    <div style="display: flex; gap: var(--spacing-md); height: 500px;">
        <!-- Available Tables -->
        <div class="card" style="flex: 1; display: flex; flex-direction: column;">
            <h3 style="margin-bottom: var(--spacing-sm);">Available Tables</h3>
            <input type="text" id="table-search" class="form-input" placeholder="Filter tables..."
                style="margin-bottom: var(--spacing-sm);">

            <div id="available-tables"
                style="flex: 1; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: var(--spacing-sm);">
                <div style="color: #aaa; text-align: center; margin-top: 20px;">Select a source connection
                    to view tables.</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; flex-direction: column; justify-content: center; gap: var(--spacing-sm);">
            <button class="btn btn-secondary" onclick="moveRight()"><i class="fas fa-angle-right"></i></button>
            <button class="btn btn-secondary" onclick="moveLeft()"><i class="fas fa-angle-left"></i></button>
            <button class="btn btn-secondary" onclick="moveAllRight()"><i
                    class="fas fa-angle-double-right"></i></button>
            <button class="btn btn-secondary" onclick="moveAllLeft()"><i class="fas fa-angle-double-left"></i></button>
        </div>

        <!-- Selected Tables -->
        <div class="card" style="flex: 1; display: flex; flex-direction: column;">
            <h3 style="margin-bottom: var(--spacing-sm);">Selected Tables (Target)</h3>
            <div id="selected-tables"
                style="flex: 1; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: var(--spacing-sm);">
                <!-- Selected tables will appear here -->
            </div>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div id="progress-overlay" class="progress-overlay" style="display: none;">
    <div class="progress-modal">
        <div class="progress-modal-header">
            <div class="progress-spinner">
                <div class="spinner-ring"></div>
                <i class="fas fa-database spinner-icon"></i>
            </div>
            <h2 class="progress-title">매핑 생성 중...</h2>
            <p class="progress-subtitle" id="progress-subtitle">소스 DB에서 테이블 메타데이터를 조회하고 있습니다</p>
        </div>
        <div class="progress-body">
            <div class="progress-bar-container">
                <div class="progress-bar-track">
                    <div class="progress-bar-fill" id="progress-bar-fill"></div>
                </div>
                <span class="progress-percent" id="progress-percent">0%</span>
            </div>
            <div class="progress-table-list" id="progress-table-list">
                <!-- Dynamic table progress items -->
            </div>
            <div class="progress-footer">
                <div class="progress-elapsed">
                    <i class="fas fa-clock"></i>
                    <span id="progress-elapsed-time">경과 시간: 0초</span>
                </div>
                <div class="progress-tip">
                    <i class="fas fa-info-circle"></i>
                    테이블 수에 따라 수 분이 소요될 수 있습니다
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .progress-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .progress-modal {
        background: var(--bg-secondary, #1e1e2e);
        border: 1px solid var(--border-color, #333);
        border-radius: 16px;
        width: 480px;
        max-width: 90vw;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        overflow: hidden;
        animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .progress-modal-header {
        text-align: center;
        padding: 32px 24px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .progress-spinner {
        position: relative;
        width: 64px;
        height: 64px;
        margin: 0 auto 16px;
    }

    .spinner-ring {
        position: absolute;
        inset: 0;
        border: 3px solid rgba(99, 102, 241, 0.15);
        border-top-color: #6366f1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .spinner-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 22px;
        color: #6366f1;
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 0.6;
        }

        50% {
            opacity: 1;
        }
    }

    .progress-title {
        font-size: 20px;
        font-weight: 600;
        color: #e2e8f0;
        margin: 0 0 6px;
    }

    .progress-subtitle {
        font-size: 13px;
        color: #94a3b8;
        margin: 0;
    }

    .progress-body {
        padding: 20px 24px 24px;
    }

    .progress-bar-container {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .progress-bar-track {
        flex: 1;
        height: 8px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-bar-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #6366f1, #818cf8);
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .progress-percent {
        font-size: 13px;
        font-weight: 600;
        color: #818cf8;
        min-width: 36px;
        text-align: right;
    }

    .progress-table-list {
        max-height: 180px;
        overflow-y: auto;
        margin-bottom: 16px;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .progress-table-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.03);
        font-size: 13px;
        color: #cbd5e1;
        transition: all 0.3s ease;
    }

    .progress-table-item.active {
        background: rgba(99, 102, 241, 0.1);
        color: #e2e8f0;
    }

    .progress-table-item.done {
        color: #4ade80;
    }

    .progress-table-item .item-icon {
        width: 18px;
        text-align: center;
        font-size: 12px;
    }

    .progress-table-item.pending .item-icon {
        color: #475569;
    }

    .progress-table-item.active .item-icon {
        color: #818cf8;
    }

    .progress-table-item.done .item-icon {
        color: #4ade80;
    }

    .progress-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.06);
        font-size: 12px;
        color: #64748b;
    }

    .progress-elapsed {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .progress-tip {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* Scrollbar for progress list */
    .progress-table-list::-webkit-scrollbar {
        width: 4px;
    }

    .progress-table-list::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const sourceSelect = document.getElementById('source-conn');
    const availableContainer = document.getElementById('available-tables');
    const selectedContainer = document.getElementById('selected-tables');

    sourceSelect.addEventListener('change', function () {
        const connId = this.value;
        if (connId) {
            fetch(`/admin/mappings/fetch_tables/${connId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        alert('Error fetching tables: ' + data.message);
                        return;
                    }
                    availableContainer.innerHTML = '';
                    if (data.tables && data.tables.length > 0) {
                        data.tables.forEach(table => {
                            const div = document.createElement('div');
                            div.style.padding = '8px';
                            div.style.display = 'flex';
                            div.style.alignItems = 'center';
                            div.innerHTML = `
                                    <input type="checkbox" value="${table}" style="margin-right: 8px;">
                                    <i class="fas fa-table" style="color: #aaa; margin-right: 8px;"></i> ${table}
                                `;
                            availableContainer.appendChild(div);
                        });
                    } else {
                        availableContainer.innerHTML = '<div style="color: #aaa; text-align: center; margin-top: 20px;">No tables found.</div>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while fetching tables. Please check the console for details.');
                });
        } else {
            availableContainer.innerHTML = '<div style="color: #aaa; text-align: center; margin-top: 20px;">Select a source connection to view tables.</div>';
        }
    });

    // Table Search Logic
    const searchInput = document.getElementById('table-search');
    searchInput.addEventListener('input', function () {
        const filter = this.value.toLowerCase();
        const items = availableContainer.querySelectorAll('div');

        items.forEach(item => {
            // Skip the "No tables found" or "Select connection" message if it exists
            if (item.querySelector('input[type="checkbox"]')) {
                const text = item.textContent.trim().toLowerCase();
                if (text.includes(filter)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            }
        });
    });

    function moveRight() {
        const checkboxes = availableContainer.querySelectorAll('input[type="checkbox"]:checked');
        checkboxes.forEach(cb => {
            const table = cb.value;
            const div = cb.parentElement;

            // Check if already selected
            if (!selectedContainer.querySelector(`input[value="${table}"]`)) {
                const newDiv = div.cloneNode(true);
                newDiv.querySelector('input').checked = false;
                // Add mapping hint (optional)
                const hint = document.createElement('span');
                hint.style.fontSize = '12px';
                hint.style.color = '#aaa';
                hint.style.marginLeft = 'auto';
                hint.innerText = ' -> ' + table.split('.').pop().toLowerCase();
                newDiv.appendChild(hint);

                selectedContainer.appendChild(newDiv);
            }
            div.remove();
        });
    }

    function moveLeft() {
        const checkboxes = selectedContainer.querySelectorAll('input[type="checkbox"]:checked');
        checkboxes.forEach(cb => {
            const table = cb.value;
            const div = cb.parentElement;

            // Restore logic: simplified, just add back to list
            const newDiv = document.createElement('div');
            newDiv.style.padding = '8px';
            newDiv.style.display = 'flex';
            newDiv.style.alignItems = 'center';
            newDiv.innerHTML = `
                    <input type="checkbox" value="${table}" style="margin-right: 8px;">
                    <i class="fas fa-table" style="color: #aaa; margin-right: 8px;"></i> ${table}
                `;
            availableContainer.appendChild(newDiv);
            div.remove();
        });
    }

    function moveAllRight() {
        // Move all visible items in availableContainer
        const items = availableContainer.querySelectorAll('div');
        items.forEach(div => {
            if (div.style.display !== 'none' && div.querySelector('input[type="checkbox"]')) {
                const cb = div.querySelector('input[type="checkbox"]');
                const table = cb.value;

                if (!selectedContainer.querySelector(`input[value="${table}"]`)) {
                    const newDiv = div.cloneNode(true);
                    newDiv.querySelector('input').checked = false;
                    const hint = document.createElement('span');
                    hint.style.fontSize = '12px';
                    hint.style.color = '#aaa';
                    hint.style.marginLeft = 'auto';
                    hint.innerText = ' -> ' + table.split('.').pop().toLowerCase();
                    newDiv.appendChild(hint);
                    selectedContainer.appendChild(newDiv);
                }
                div.remove();
            }
        });
    }

    function moveAllLeft() {
        const items = selectedContainer.querySelectorAll('div');
        items.forEach(div => {
            if (div.querySelector('input[type="checkbox"]')) {
                const cb = div.querySelector('input[type="checkbox"]');
                const table = cb.value;

                const newDiv = document.createElement('div');
                newDiv.style.padding = '8px';
                newDiv.style.display = 'flex';
                newDiv.style.alignItems = 'center';
                newDiv.innerHTML = `
                        <input type="checkbox" value="${table}" style="margin-right: 8px;">
                        <i class="fas fa-table" style="color: #aaa; margin-right: 8px;"></i> ${table}
                    `;
                availableContainer.appendChild(newDiv);
                div.remove();
            }
        });
    }

    // ── Progress Modal Helpers ──
    let progressTimer = null;
    let progressStartTime = null;

    function showProgress(tables) {
        const overlay = document.getElementById('progress-overlay');
        const listEl = document.getElementById('progress-table-list');
        const barFill = document.getElementById('progress-bar-fill');
        const pctLabel = document.getElementById('progress-percent');
        const subtitle = document.getElementById('progress-subtitle');

        // build item list
        listEl.innerHTML = '';
        tables.forEach((t, i) => {
            const div = document.createElement('div');
            div.className = 'progress-table-item pending';
            div.id = `prog-item-${i}`;
            div.innerHTML = `
                <span class="item-icon"><i class="fas fa-circle"></i></span>
                <span>${t}</span>
            `;
            listEl.appendChild(div);
        });

        // reset bar
        barFill.style.width = '0%';
        pctLabel.textContent = '0%';
        subtitle.textContent = '소스 DB에서 테이블 메타데이터를 조회하고 있습니다';

        overlay.style.display = 'flex';

        // elapsed timer
        progressStartTime = Date.now();
        const elapsedSpan = document.getElementById('progress-elapsed-time');
        progressTimer = setInterval(() => {
            const sec = Math.floor((Date.now() - progressStartTime) / 1000);
            elapsedSpan.textContent = `경과 시간: ${sec}초`;
        }, 1000);

        // fake incremental progress (simulates per-table progress)
        simulateProgress(tables);
    }

    function simulateProgress(tables) {
        const total = tables.length;
        let current = 0;
        const barFill = document.getElementById('progress-bar-fill');
        const pctLabel = document.getElementById('progress-percent');
        const subtitle = document.getElementById('progress-subtitle');

        // Step through tables with estimated timing
        function advanceNext() {
            if (current >= total) return;

            // mark current as active
            const item = document.getElementById(`prog-item-${current}`);
            if (item) {
                item.className = 'progress-table-item active';
                item.querySelector('.item-icon').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            subtitle.textContent = `처리 중: ${tables[current]}  (${current + 1}/${total})`;

            // mark previous as done
            if (current > 0) {
                const prev = document.getElementById(`prog-item-${current - 1}`);
                if (prev) {
                    prev.className = 'progress-table-item done';
                    prev.querySelector('.item-icon').innerHTML = '<i class="fas fa-check-circle"></i>';
                }
            }

            const pct = Math.round(((current + 0.5) / total) * 90); // cap at 90% until real response
            barFill.style.width = pct + '%';
            pctLabel.textContent = pct + '%';

            current++;
            if (current < total) {
                setTimeout(advanceNext, 2000 + Math.random() * 1500);
            }
        }
        advanceNext();
    }

    function completeProgress(success) {
        const barFill = document.getElementById('progress-bar-fill');
        const pctLabel = document.getElementById('progress-percent');
        const subtitle = document.getElementById('progress-subtitle');
        const titleEl = document.querySelector('.progress-title');

        // mark all done
        document.querySelectorAll('.progress-table-item').forEach(item => {
            item.className = 'progress-table-item done';
            item.querySelector('.item-icon').innerHTML = '<i class="fas fa-check-circle"></i>';
        });

        barFill.style.width = '100%';
        pctLabel.textContent = '100%';

        if (success) {
            subtitle.textContent = '모든 매핑이 성공적으로 생성되었습니다!';
            titleEl.textContent = '매핑 생성 완료  ✓';
            document.querySelector('.spinner-ring').style.animation = 'none';
            document.querySelector('.spinner-ring').style.borderColor = '#4ade80';
            document.querySelector('.spinner-icon').className = 'fas fa-check spinner-icon';
            document.querySelector('.spinner-icon').style.color = '#4ade80';
        } else {
            subtitle.textContent = '매핑 생성 중 오류가 발생했습니다';
            titleEl.textContent = '오류 발생';
            document.querySelector('.spinner-ring').style.animation = 'none';
            document.querySelector('.spinner-ring').style.borderColor = '#f87171';
            document.querySelector('.spinner-icon').className = 'fas fa-exclamation-triangle spinner-icon';
            document.querySelector('.spinner-icon').style.color = '#f87171';
        }

        clearInterval(progressTimer);
    }

    function hideProgress() {
        document.getElementById('progress-overlay').style.display = 'none';
        clearInterval(progressTimer);
    }

    // ── Generate Mapping ──
    function generateMapping() {
        const sourceConnId = document.getElementById('source-conn').value;
        const targetConnId = document.getElementById('target-conn').value;
        const selectedInputs = selectedContainer.querySelectorAll('input[type="checkbox"]');

        if (!sourceConnId || !targetConnId) {
            alert('Source Connection과 Target Connection을 모두 선택해주세요.');
            return;
        }

        if (selectedInputs.length === 0) {
            alert('선택된 테이블이 없습니다. 테이블을 Selected 목록으로 이동해주세요.');
            return;
        }

        const tables = Array.from(selectedInputs).map(input => input.value);

        // Show progress modal
        showProgress(tables);

        fetch('/admin/mappings/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                source_conn_id: sourceConnId,
                target_conn_id: targetConnId,
                tables: tables
            })
        })
            .then(response => response.json())
            .then(result => {
                if (result.status === 'success') {
                    completeProgress(true);
                    setTimeout(() => {
                        window.location.href = "{{ url_for('mappings.index') }}";
                    }, 1500);
                } else {
                    completeProgress(false);
                    setTimeout(() => {
                        hideProgress();
                        alert('오류: ' + result.message);
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                completeProgress(false);
                setTimeout(() => {
                    hideProgress();
                    alert('매핑 생성 중 오류가 발생했습니다. 콘솔을 확인해주세요.');
                }, 2000);
            });
    }
</script>
{% endblock %}